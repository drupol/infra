{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": 44,
  "links": [],
  "liveNow": true,
  "panels": [
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 11,
      "panels": [],
      "title": "A propos de Noise Station et rÃ©glementation en RÃ©gion wallonne",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 29,
        "w": 12,
        "x": 0,
        "y": 1
      },
      "id": 6,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "# Noise Station\n\n### Un systÃ¨me de monitoring acoustique intelligent\n\nLa **Noise Station** est une solution de surveillance environnementale de haute prÃ©cision conÃ§ue pour capturer, analyser et visualiser les niveaux sonores d'un espace en temps rÃ©el. Elle transforme des donnÃ©es acoustiques brutes en indicateurs visuels pour suivre l'Ã©volution du bruit, dÃ©tecter les pics et comprendre le profil sonore d'un lieu sur 24 heures.\n\n# Comment Ã§a fonctionne ?\n\n### 1. La Capture (Le MatÃ©riel)\n\nLe systÃ¨me s'appuie sur un microphone professionnel de type **Trotec SL400** (Ã©quivalent du **CEM DT-8852**). Ce sonomÃ¨tre de Classe 2 offre des fonctionnalitÃ©s indispensables :\n-   **Double PondÃ©ration:** Supporte les courbes **dB(A)** (perception humaine) et **dB(C)** (basses frÃ©quences).\n-   **Plage Dynamique:** Mesure prÃ©cise de 30 Ã  130 dB (prÃ©cision : 1,4 dB, rÃ©solution : 0,1 dB)\n-   **Modes Temporels:** Analyse en mode \"Fast\" (rÃ©activitÃ© immÃ©diate) ou \"Slow\" (stabilitÃ©).\n-   **Signaux numÃ©riques:** Uniquement les donnÃ©es numÃ©riques (et pas analogique) sont transmises. \n-   **Certification:** LivrÃ© avec certificat de calibration, conforme Ã  IEC61672-1 Class 2\n\n### 2. Le CÅ“ur du SystÃ¨me (L'Intelligence)\n\nLes donnÃ©es sont traitÃ©es par une unitÃ© de calcul (**Raspberry Pi**) et stockÃ©es dans une base de donnÃ©es temporelle (**InfluxDB**):\n*   **Nettoyage :** Filtrage des mÃ©tadonnÃ©es pour une lecture fluide.\n*   **AgrÃ©gation :** Calcul de statistiques avancÃ©es (L10, L50, L90) en temps rÃ©el.\n\n### 3. La Visualisation (Le Dashboard)\n\nLe dashboard est structurÃ© en quatre axes complÃ©mentaires pour une lecture immÃ©diate :\n\n*   **Vue Temps RÃ©el (Live View) :** Un graphique temporel affichant le **Bruit de Fond (L90)**. Cet indicateur filtre les pics passagers (voitures, voix) pour rÃ©vÃ©ler le niveau sonore constant et permanent (la signature d'une installation technique comme une pompe Ã  chaleur).\n*   **Pic de Volume (Volume Maximum EnregistrÃ©) :** Une jauge dynamique qui surveille le volume maximal atteint durant les **5 derniÃ¨res minutes**. Elle utilise des seuils colorÃ©s (du vert au rouge foncÃ© dÃ¨s 80 dB) pour alerter sur les Ã©vÃ©nements sonores rÃ©cents.\n*   **Profil Statistique (FrÃ©quence Sonore) :** Un histogramme qui regroupe les mesures des derniÃ¨res 24 heures par paliers de dÃ©cibels (arrondis Ã  l'unitÃ©). Il permet de voir en un coup d'Å“il quel niveau de bruit est le plus frÃ©quent dans l'environnement.\n*   **Distribution Horaire :** Un graphique en barres affichant la **moyenne sonore pour chaque heure** de la journÃ©e. IdÃ©al pour identifier les cycles de pollution sonore (journÃ©e de travail vs nuit).\n*   **GÃ©olocalisation :** Une carte intÃ©grÃ©e affichant l'emplacement prÃ©cis du capteur.\n\n# Pourquoi utiliser Noise Station ?\n\nPasser du ressenti subjectif (\"c'est bruyant\") Ã  une mesure objective (\"la moyenne est de 65 dB avec des pics Ã  85 dB\"). Que ce soit pour le confort au travail, la surveillance de voisinage ou l'analyse environnementale, la **Noise Station** fournit une preuve scientifique et visuelle de la rÃ©alitÃ© acoustique de votre environnement.",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 29,
        "w": 12,
        "x": 12,
        "y": 1
      },
      "id": 7,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "# RÃ©glementation en RÃ©gion wallonne\n\nEn RÃ©gion wallonne (https://www.ejustice.just.fgov.be/eli/arrete/2002/07/04/2002027815/justel), le cadre lÃ©gal est clair et rigoureux. Depuis lâ€™arrÃªtÃ© du Gouvernement wallon du 4 juillet 2022, des limites de bruit spÃ©cifiques sâ€™appliquent aux PAC selon les diffÃ©rentes pÃ©riodes de la journÃ©e :\n\n- En journÃ©e (7h-19h): le bruit ne doit pas dÃ©passer 50 dB.\n- En transition (6h-7h, 19h-22h): la limite est rÃ©duite Ã  45 dB.\n- La nuit (22h-6h): le niveau sonore doit impÃ©rativement rester sous 40 dB.\n\nLe bruit se propage en cercle autour d'une unitÃ© extÃ©rieure (PAC). \nIl est donc crucial de faire attention aux surfaces environnantes, comme des murs ou dâ€™autres bÃ¢timents, qui peuvent rÃ©flÃ©chir le son et provoquer un effet dâ€™Ã©cho. Pour limiter cette rÃ©sonance, maintenez au moins un mÃ¨tre dâ€™espace autour de la pompe, en particulier par rapport aux fenÃªtres, aux portes et aux chemins. Si lâ€™unitÃ© est placÃ©e contre un mur, veillez Ã  respecter une distance minimale de 30 centimÃ¨tres â€” lâ€™idÃ©al Ã©tant de 50 centimÃ¨tres â€” pour garantir une circulation sonore optimale. Il est Ã©galement important de prendre en compte la distance entre la face avant de la pompe Ã  chaleur et les trottoirs, qui doit Ãªtre dâ€™au moins 3 mÃ¨tres et dâ€™au moins 6 mÃ¨tres pour les plantes.\n\nSource: https://www.bobex.be/fr-be/pompe-a-chaleur/installation/distance-voisin/\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 30
      },
      "id": 16,
      "panels": [],
      "title": "Surveillance en Temps RÃ©el et ConformitÃ©",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 28,
        "w": 24,
        "x": 0,
        "y": 31
      },
      "id": 17,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Cette section met en regard le **niveau sonore en temps rÃ©el** et les **seuils rÃ©glementaires applicables en RÃ©gion wallonne**.\n\n### Vue en Temps RÃ©el\n\nLe panneau *Vue en Temps RÃ©el* part des mesures **SPL** (dB) issues de la sÃ©rie `dt8852/spl`, puis applique le traitement suivant :\n\n1. **Extraction du Bruit de Fond (L90)** : Pour chaque fenÃªtre de temps, l'algorithme retient la valeur **statistique L90** (le niveau dÃ©passÃ© 90% du temps). Cela Ã©limine mathÃ©matiquement les Ã©vÃ©nements sonores brefs (pics, voix, passage de voiture) pour ne garder que l'ambiance sonore de fond (machinerie, vent lointain).\n2. **Conversion & Lissage** : Les valeurs L90 sont converties en Ã©nergie, lissÃ©es sur 1 minute, puis reconverties en dB.\n\nCette mÃ©thode permet d'isoler la **signature sonore des Ã©quipements fixes** (ex: Pompes Ã  chaleur) en ignorant les bruits parasites.\n\nLes seuils de couleur sur la courbe (vert/jaune/orange/rouge) permettent dâ€™identifier dâ€™un coup dâ€™Å“il si le niveau de fond se situe sous 40/45/50 dB, ou sâ€™il sâ€™en approche / les dÃ©passe.\n\n### Historique des Infractions\n\nUne seconde sÃ©rie calcule une **limite horaire** en fonction de lâ€™heure locale (Europe/Brussels) :\n- **50 dB** entre 07hâ€“19h  \n- **45 dB** entre 06hâ€“07h et 19hâ€“22h  \n- **40 dB** entre 22hâ€“06h  \n\n### Analyse des Ã‰mergences : ConformitÃ© aux Seuils LÃ©gaux\n\nCette visualisation est un outil de monitoring critique dÃ©diÃ© Ã  la **conformitÃ© environnementale**. Ce graphique compare directement le **Bruit de Fond (L90)** aux limites autorisÃ©es. \n\nL'algorithme adapte dynamiquement le seuil de tolÃ©rance selon l'heure locale (Europe/Bruxelles) : \n*   **50 dB** durant la journÃ©e (07:00 - 19:00)\n*   **45 dB** durant les pÃ©riodes de transition (06:00 - 07:00 et 19:00 - 22:00)\n*   **40 dB** durant la pÃ©riode nocturne (22:00 - 06:00)\n\nChaque pic affichÃ© reprÃ©sente une **infraction potentielle du bruit de fond** : sa hauteur indique l'intensitÃ© du dÃ©passement en dÃ©cibels (dB). Un dÃ©passement ici signifie que le bruit est CONSTANT et supÃ©rieur Ã  la loi.\n\n### SÃ©vÃ©ritÃ© des Nuisances Acoustiques\n\nCette visualisation sous forme de frise temporelle offre une lecture immÃ©diate et synthÃ©tique de la qualitÃ© de l'environnement sonore sur une pÃ©riode donnÃ©e.\n\nLe systÃ¨me analyse chaque mesure en fonction des seuils lÃ©gaux variables. Lorsqu'un bruit excÃ¨de la limite autorisÃ©e, il est automatiquement classifiÃ© selon l'importance du dÃ©passement (l'Ã©mergence) :\n\n- Jaune / ModÃ©rÃ© : Nuisance perceptible (5 Ã  10 dB)\n- Orange / Fort : Pollution sonore marquÃ©e (10 Ã  15 dB)\n- Rouge / Critique : Nuisance majeure (15 Ã  20 dB)\n\nCette approche permet de transformer des milliers de points de donnÃ©es en un calendrier visuel, idÃ©al pour repÃ©rer des cycles de nuisances rÃ©currents.",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Affiche le SPL reconstruit sur des fenÃªtres de 30s Ã  partir des mesures: conversion dBâ†’Ã©nergie, agrÃ©gation en Ã©nergie, puis reconversion en dB. La courbe est comparÃ©e Ã  une limite rÃ©glementaire dynamique (40/45/50 dB) calculÃ©e Ã  partir de lâ€™heure locale.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "green",
            "mode": "thresholds",
            "seriesBy": "last"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 25,
            "gradientMode": "scheme",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineStyle": {
              "fill": "solid"
            },
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": true,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "displayName": "Sound Pressure Level (dB)",
          "fieldMinMax": false,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              },
              {
                "color": "dark-yellow",
                "value": 40
              },
              {
                "color": "dark-orange",
                "value": 45
              },
              {
                "color": "dark-red",
                "value": 50
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "_limit"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Limite en RÃ©gion Wallonne"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "#ffffff",
                  "mode": "fixed"
                }
              },
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [10, 10],
                  "fill": "dash"
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              }
            ]
          },
          {
            "matcher": {
              "id": "byFrameRefID",
              "options": "B"
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              },
              {
                "id": "color",
                "value": {
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "DÃ©passement (dB)"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "DÃ©passement (dB)"
              },
              {
                "id": "color",
                "value": {
                  "mode": "thresholds"
                }
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": 0
                    },
                    {
                      "color": "#EAB839",
                      "value": 5
                    },
                    {
                      "color": "dark-orange",
                      "value": 10
                    },
                    {
                      "color": "dark-red",
                      "value": 15
                    },
                    {
                      "color": "dark-purple",
                      "value": 20
                    }
                  ]
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 15,
        "w": 24,
        "x": 0,
        "y": 59
      },
      "id": 1,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\")\n  |> filter(fn: (r) => r[\"_field\"] == \"spl\")\n  // 1. On garde le bruit de fond\n  |> aggregateWindow(every: v.windowPeriod, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n  \n  // 2. Ã‰nergie linÃ©aire\n  |> map(fn: (r) => ({ r with _value: math.pow(x: 10.0, y: r._value / 10.0) }))\n\n  // 3. Moyenne sur 1 minute (premier lissage temporel)\n  |> aggregateWindow(every: 1m, fn: mean, createEmpty: false)\n\n  // 4. Retour en dB\n  |> map(fn: (r) => ({\n      r with \n      _value: 10.0 * math.log10(x: r._value),\n      _field: \"Niveau de Pression Sonore\"\n  }))\n  |> yield(name: \"spl_result\")",
          "refId": "Live"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> filter(fn: (r) => exists r._value)\n  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)\n\n  // 3. Calcul des limites horaires et du dÃ©passement\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      \n      // Seuils rÃ©glementaires (50 / 45 / 40 dB)\n      limite = if h >= 7 and h < 19 then 50.0 \n               else if h == 6 or (h >= 19 and h < 22) then 45.0 \n               else 40.0\n      \n      // Calcul du dÃ©passement\n      diff = if r._value > limite then r._value - limite else 0.0\n      \n      return {\n          _time: r._time,\n          _value: diff,\n          _field: \"DÃ©passement (dB)\",\n      }\n  })\n  \n  // 4. Envoi des donnÃ©es vers Grafana\n  |> yield(name: \"depassement_acoustique\")",
          "refId": "B"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"date\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"dt8852\" and r._field == \"spl\")\n  |> aggregateWindow(every: v.windowPeriod, fn: first)\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      return {\n          _time: r._time,\n          _limit: if h >= 7 and h < 19 then 50.0 \n                  else if h == 6 or (h >= 19 and h < 22) then 45.0 \n                  else 40.0\n      }\n  })",
          "refId": "A"
        }
      ],
      "title": "Vue en Temps RÃ©el",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Encode la conformitÃ© minute par minute. Les donnÃ©es SPL sont agrÃ©gÃ©es par minute, puis comparÃ©es Ã  la limite horaire (40/45/50 dB) calculÃ©e sur la mÃªme horodatation. Le rÃ©sultat est un statut binaire: conforme ou infraction\n",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "axisPlacement": "auto",
            "fillOpacity": 70,
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineWidth": 0,
            "spanNulls": false
          },
          "mappings": [
            {
              "options": {
                "0": {
                  "color": "dark-red",
                  "index": 0,
                  "text": "Infraction"
                },
                "1": {
                  "color": "dark-green",
                  "index": 1,
                  "text": "Conforme"
                }
              },
              "type": "value"
            }
          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 5,
        "w": 24,
        "x": 0,
        "y": 74
      },
      "id": 8,
      "options": {
        "alignValue": "left",
        "legend": {
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "mergeValues": true,
        "rowHeight": 0.9,
        "showValue": "auto",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  // FenÃªtrage pour allÃ©ger le rendu (ex: toutes les 1m)\n  |> aggregateWindow(every: 1m, fn: max, createEmpty: false)\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      limit = if h >= 7 and h < 19 then 50.0 \n              else if h == 6 or (h >= 19 and h < 22) then 45.0 \n              else 40.0\n      \n      return { _time: r._time, _field: \"Statut\", _value: if r._value > limit then \"0\" else \"1\" }\n  })",
          "refId": "A"
        }
      ],
      "title": "Historique des Infractions",
      "type": "state-timeline"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Suivi en temps rÃ©el du dÃ©passement des limites acoustiques rÃ©glementaires (50/45/40 dB) avec dÃ©tection automatique des pÃ©riodes Jour, Aube, Soir et Nuit.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineStyle": {
              "fill": "solid"
            },
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "seuil_legal"
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": false
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": 0
                    },
                    {
                      "color": "dark-orange",
                      "value": 45
                    },
                    {
                      "color": "dark-red",
                      "value": 50
                    }
                  ]
                }
              },
              {
                "id": "color",
                "value": {
                  "mode": "thresholds",
                  "seriesBy": "last"
                }
              },
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [10, 10],
                  "fill": "dash"
                }
              },
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              },
              {
                "id": "displayName",
                "value": "Seuil Legal"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "niveau_reel"
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              },
              {
                "id": "displayName",
                "value": "Niveau reel"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "_value"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "DÃ©passement (dB)"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 24,
        "x": 0,
        "y": 79
      },
      "id": 23,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"math\"\nimport \"timezone\"\nimport \"date\"\n\n// 1. Configuration de l'environnement\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> filter(fn: (r) => exists r._value)\n  \n  // 2. AgrÃ©gation temporelle (Ã©vite l'erreur de trop grand nombre de points)\n  //|> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)\n  |> aggregateWindow(every: v.windowPeriod, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n  // 3. Calcul des limites horaires et du dÃ©passement\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      \n      // Seuils rÃ©glementaires (50 / 45 / 40 dB)\n      limite = if h >= 7 and h < 19 then 50.0 \n               else if h == 6 or (h >= 19 and h < 22) then 45.0 \n               else 40.0\n      \n      // Calcul du dÃ©passement\n      diff = if r._value > limite then r._value - limite else 0.0\n      \n      return {\n          _time: r._time,\n          _value: diff,\n          _field: \"DÃ©passement (dB)\",\n          niveau_reel: r._value,\n          seuil_legal: limite,\n          statut: if diff > 0.0 then \"ðŸ”´ INFRACTION\" else \"ðŸŸ¢ CONFORME\"\n      }\n  })\n  \n  // 4. Envoi des donnÃ©es vers Grafana\n  |> yield(name: \"depassement_acoustique\")",
          "refId": "A"
        }
      ],
      "title": "Analyse des Ã‰mergences : ConformitÃ© aux Seuils LÃ©gaux",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Vue chronologique classifiant l'intensitÃ© des dÃ©passements acoustiques par rapport aux limites rÃ©glementaires (50/45/40 dB) par paliers de sÃ©vÃ©ritÃ©.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "axisPlacement": "auto",
            "fillOpacity": 80,
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineWidth": 0,
            "spanNulls": false
          },
          "fieldMinMax": false,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              },
              {
                "color": "dark-yellow",
                "value": 5
              },
              {
                "color": "dark-orange",
                "value": 10
              },
              {
                "color": "dark-red",
                "value": 15
              },
              {
                "color": "dark-purple",
                "value": 20
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 24,
        "x": 0,
        "y": 87
      },
      "id": 24,
      "options": {
        "alignValue": "left",
        "legend": {
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "mergeValues": true,
        "rowHeight": 1,
        "showValue": "never",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"math\"\nimport \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> aggregateWindow(every: v.windowPeriod, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      limite = if h >= 7 and h < 19 then 50.0 \n               else if h == 6 or (h >= 19 and h < 22) then 45.0 \n               else 40.0\n      \n      depassement = if r._value > limite then r._value - limite else 0.0\n      \n      return {\n          _time: r._time,\n          _value: depassement,\n          _field: \"DÃ©passement (dB)\",\n      }\n  })\n",
          "refId": "A"
        }
      ],
      "title": "SÃ©vÃ©ritÃ© des Nuisances Acoustiques",
      "type": "state-timeline"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 95
      },
      "id": 14,
      "panels": [],
      "title": "Profil Sonore et Rythmes Horaires",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 6,
        "w": 24,
        "x": 0,
        "y": 96
      },
      "id": 15,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Cette section dÃ©crit la **signature acoustique** du lieu sur la durÃ©e, en distinguant le **bruit de fond** des Ã©pisodes plus marquÃ©s.\n\n### FrÃ©quence sonore\n\nLes mesures sont dâ€™abord regroupÃ©es pour rÃ©duire le volume de donnÃ©es, puis classÃ©es par **paliers de 3 dB**. Ce choix facilite lâ€™interprÃ©tation, car un pas de 3 dB correspond Ã  une variation Ã©nergÃ©tique significative.  \nLes sÃ©ries sont ensuite sÃ©parÃ©es par pÃ©riodes (jour, soirÃ©e, aube, nuit) afin de comparer les distributions selon lâ€™heure.\n\n### Histogramme de Pression Sonore\n\nLe second graphique calcule la **mÃ©diane** du niveau sonore sur des fenÃªtres de **15 minutes**. La mÃ©diane rÃ©duit lâ€™influence des bruits brefs et met en Ã©vidence lâ€™ambiance sonore typique et les rythmes rÃ©guliers (jour/nuit, pics dâ€™activitÃ©).\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Histogramme des niveaux sonores classÃ©s par paliers de 3 dB et sÃ©parÃ©s par pÃ©riodes horaires (jour / aube / soirÃ©e / nuit). Les donnÃ©es sont prÃ©alablement regroupÃ©es pour limiter le volume affichÃ©. Utile pour identifier le niveau dominant (bruit de fond) et la dispersion des niveaux.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "fillOpacity": 80,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "stacking": {
              "group": "A",
              "mode": "none"
            }
          },
          "mappings": [],
          "max": 120,
          "min": 30,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Jour (Limite 50dB)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-blue",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "SoirÃ©e (Limite 45dB)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Aube / MatinÃ©e (Limite 45dB)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Nuit (Limite 40dB)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#000064",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 15,
        "w": 24,
        "x": 0,
        "y": 102
      },
      "id": 3,
      "options": {
        "combine": false,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  // 1. Keep data volume safe (10s resolution)\n  |> aggregateWindow(every: 10s, fn: last, createEmpty: false)\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      \n      // 2. Define the four distinct periods\n      period = if h >= 7 and h < 19 then \"Jour (Limite 50dB)\"\n               else if h >= 19 and h < 22 then \"SoirÃ©e (Limite 45dB)\"\n               else if h >= 6 and h < 7 then \"Aube / MatinÃ©e (Limite 45dB)\"\n               else \"Nuit (Limite 40dB)\"\n      \n      return { r with \n          // 3. Bucket by 3dB for acoustic significance\n          _value: math.floor(x: r._value / 3.0) * 3.0,\n          // 4. Use the period name as the field for the histogram series\n          _field: period\n      }\n  })\n  |> keep(columns: [\"_time\", \"_value\", \"_field\"])",
          "refId": "A"
        }
      ],
      "title": "FrÃ©quence Sonore",
      "type": "histogram"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Affiche la mÃ©diane du niveau sonore par fenÃªtres de 15 minutes. Ce choix met en avant le niveau typique en limitant lâ€™impact des Ã©vÃ©nements brefs. IdÃ©al pour visualiser les cycles dâ€™activitÃ© et les pÃ©riodes de calme relatif.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "fillOpacity": 80,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 2,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "fieldMinMax": true,
          "mappings": [],
          "max": 80,
          "min": 40,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 14,
        "w": 24,
        "x": 0,
        "y": 117
      },
      "id": 4,
      "options": {
        "barRadius": 0,
        "barWidth": 0.6,
        "colorByField": "Time",
        "fullHighlight": false,
        "groupWidth": 1,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": false
        },
        "orientation": "auto",
        "showValue": "auto",
        "stacking": "none",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        },
        "xField": "Time",
        "xTickLabelRotation": 0,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\")\n  |> filter(fn: (r) => r[\"_field\"] == \"spl\")\n  |> keep(columns: [\"_time\", \"_value\", \"_field\", \"frequency_weighting\"])\n  //|> aggregateWindow(every: 15m, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n  |> aggregateWindow(every: 15m, fn: mean, createEmpty: false)\n  |> map(fn: (r) => ({ \n      r with \n      _value: math.round(x: r._value),\n      _field: \"Niveau de Pression Sonore\" \n  }))  \n  |> yield(name: \"hourly_peaks\")",
          "refId": "A"
        }
      ],
      "title": "Histogramme de Pression Sonore",
      "type": "barchart"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 131
      },
      "id": 12,
      "panels": [],
      "title": "Analyse des Ã‰vÃ©nements et Nuisances",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 10,
        "w": 24,
        "x": 0,
        "y": 132
      },
      "id": 13,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Ce module met en Ã©vidence les Ã©vÃ©nements les plus significatifs, en distinguant les **pics** et les **nuisances durables**.\n\n### Volume maximum enregistrÃ©\n\nLa jauge indique le **niveau sonore le plus Ã©levÃ©** observÃ© sur la pÃ©riode affichÃ©e. Elle sert Ã  repÃ©rer un choc acoustique potentiel, sans tenir compte de sa durÃ©e.\n\n### Nuisances persistantes (> 60 dB)\n\nCe panneau recherche des sÃ©quences oÃ¹ le niveau reste **au-dessus de 60 dB** de maniÃ¨re continue pendant suffisamment longtemps pour Ãªtre qualifiÃ© de nuisance.\n\nTraitement appliquÃ© :\n1. Regroupement des mesures sur des tranches courtes pour stabiliser lâ€™analyse.\n2. Lissage rÃ©alisÃ© sur une grandeur Ã©nergÃ©tique (et non directement en dB) afin dâ€™Ã©viter que de petites oscillations autour du seuil ne fragmentent artificiellement une sÃ©quence.\n3. Calcul de la durÃ©e pendant laquelle le niveau reste au-dessus du seuil, puis filtrage pour ne conserver que les Ã©pisodes dâ€™au moins **2 minutes**.\n\nLe graphique affiche simultanÃ©ment lâ€™intensitÃ© (en dB) et la durÃ©e de lâ€™Ã©pisode (en secondes), afin de relier niveau et persistance.\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Analyse approfondie des Ã©vÃ©nements sonores significatifs. Ce panneau isole et visualise les pÃ©riodes oÃ¹ le niveau sonore a dÃ©passÃ© 60 dB de maniÃ¨re continue pendant plus de 2 minutes (120s), permettant d'identifier les nuisances longues et persistantes par rapport aux bruits transitoires.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 6,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": true,
            "spanNulls": true,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "dtdurations"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "DurÃ©e de la nuisance (> 60dB)"
            },
            "properties": [
              {
                "id": "custom.axisPlacement",
                "value": "right"
              },
              {
                "id": "unit",
                "value": "dtdurations"
              },
              {
                "id": "custom.lineInterpolation",
                "value": "stepBefore"
              },
              {
                "id": "custom.fillOpacity",
                "value": 50
              },
              {
                "id": "custom.scaleDistribution",
                "value": {
                  "log": 2,
                  "type": "log"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "IntensitÃ©"
            },
            "properties": [
              {
                "id": "unit",
                "value": "dB"
              },
              {
                "id": "custom.lineInterpolation",
                "value": "smooth"
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "#fffd0038",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byFrameRefID",
              "options": "B"
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              },
              {
                "id": "unit",
                "value": "dB"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "_value DÃ©passement (dB)"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "DÃ©passement (dB)"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "seuil_legal"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Seuil Legal"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 11,
        "w": 24,
        "x": 0,
        "y": 142
      },
      "id": 9,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"math\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  \n  // 1. FenÃªtrage de base\n  |> aggregateWindow(every: 10s, fn: max, createEmpty: false)\n\n  // --- DÃ‰BUT DU LISSAGE Ã‰NERGÃ‰TIQUE ---\n  // 2. Conversion des dB en Ã©chelle linÃ©aire (Ã©nergie)\n  |> map(fn: (r) => ({ r with _value: math.pow(x: 10.0, y: r._value / 10.0) }))\n  \n  // 3. Moyenne glissante sur 30 secondes (6 points de 5s)\n  |> exponentialMovingAverage(n: 12)\n  \n  // 4. Retour en dÃ©cibels (Ã©chelle logarithmique)\n  |> map(fn: (r) => ({ r with _value: 10.0 * math.log10(x: r._value) }))\n  // --- FIN DU LISSAGE Ã‰NERGÃ‰TIQUE ---\n\n  // 5. Calcul de la durÃ©e consÃ©cutive au dessus de 55.0 dB\n  // On le fait sur la valeur lissÃ©e pour Ã©viter les micro-coupures du compteur\n  |> stateDuration(fn: (r) => r._value > 60.0, column: \"noisy_seconds\", unit: 1s)\n\n  // 6. Nettoyage : transformer les -1 (sous le seuil) en 0\n  |> map(fn: (r) => ({\n      r with \n      noisy_seconds: if r.noisy_seconds == -1 then 0 else r.noisy_seconds\n  }))\n\n  // 7. FILTRE : On ne garde que les sÃ©quences qui durent plus de 120s (2 minutes)\n  |> filter(fn: (r) => r.noisy_seconds >= 120)\n\n  // 8. Formatage final pour un affichage propre dans Grafana\n  |> map(fn: (r) => ({\n      _time: r._time,\n      \"IntensitÃ©\": math.round(x: r._value * 10.0) / 10.0, // Arrondi 1 dÃ©cimale\n      \"DurÃ©e de la nuisance (> 60dB)\": float(v: r.noisy_seconds)\n  }))\n  |> yield(name: \"nuisances_analyse\")",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> filter(fn: (r) => exists r._value)\n  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      \n      limite = if h >= 7 and h < 19 then 50.0 \n               else if h == 6 or (h >= 19 and h < 22) then 45.0 \n               else 40.0\n      \n      diff = if r._value > limite then r._value - limite else 0.0\n      \n      return {\n          _time: r._time,\n          _value: diff,\n          _field: \"DÃ©passement (dB)\",\n          seuil_legal: limite,\n      }\n  })\n  \n  |> yield(name: \"depassement_acoustique\")",
          "refId": "B"
        }
      ],
      "title": "Nuisances persistantes (> 60 dB)",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Indique l'intensitÃ© maximale (crÃªte) enregistrÃ©e sur la pÃ©riode sÃ©lectionnÃ©e. Les codes couleurs (Vert Ã  Rouge foncÃ©) signalent immÃ©diatement les niveaux critiques (>60dB, >75dB) nÃ©cessitant une attention particuliÃ¨re.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "fieldMinMax": false,
          "mappings": [],
          "max": 100,
          "min": 30,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "dark-green",
                "value": 30
              },
              {
                "color": "dark-yellow",
                "value": 45
              },
              {
                "color": "red",
                "value": 60
              },
              {
                "color": "dark-red",
                "value": 75
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 10,
        "w": 24,
        "x": 0,
        "y": 153
      },
      "id": 2,
      "options": {
        "minVizHeight": 75,
        "minVizWidth": 75,
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": true,
        "showThresholdMarkers": true,
        "sizing": "auto"
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\")\n  |> filter(fn: (r) => r[\"_field\"] == \"spl\")\n  |> keep(columns: [\"_time\", \"_value\", \"_field\", \"frequency_weighting\"])\n  |> max()",
          "refId": "A"
        }
      ],
      "title": "Volume Maximum EnregistrÃ©",
      "type": "gauge"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 163
      },
      "id": 20,
      "panels": [],
      "title": "Indicateurs Experts et Contexte",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 9,
        "w": 24,
        "x": 0,
        "y": 164
      },
      "id": 21,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Cette section applique des indicateurs courants de mesure acoustique pour caractÃ©riser lâ€™ambiance sonore au-delÃ  dâ€™une moyenne simple.\n\n### Indicateurs L10 / L50 / L90 (sur 60 minutes)\n\nSur chaque fenÃªtre dâ€™une heure, trois indicateurs sont calculÃ©s :\n- **L10** : Le niveau sonore dÃ©passÃ© pendant 10 % du temps. Il reprÃ©sente les Ã©vÃ©nements sonores les plus forts (passages de voitures, cris, travaux).\n- **L50** : Le niveau dÃ©passÃ© pendant 50 % du temps. C'est l'indicateur de la \"tendance\" sonore globale.\n- **L90** : Le niveau dÃ©passÃ© pendant 90 % du temps. Il reprÃ©sente le niveau sonore calme, quand il n'y a pas d'Ã©vÃ©nement particulier. C'est le \"bruit rÃ©siduel\" de la ville.\n\nCette lecture permet de sÃ©parer objectivement un bruit ambiant stable de pics plus rares mais plus forts.\n\n### Localisation du Capteur\n\nLa carte situe le capteur dans lâ€™environnement. Ce repÃ¨re est utile pour interprÃ©ter les variations (distance aux sources, obstacles, rÃ©flexions sur les faÃ§ades).\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "RÃ©partition statistique du bruit sur l'ensemble de la pÃ©riode. Trois indicateurs basÃ©s sur la distribution des niveaux sonores: \n\n- L10 (Niveau de Pointe) : Niveau dÃ©passÃ© 10% du temps. ReprÃ©sente les Ã©vÃ©nements bruyants (trafic, aboiements, travaux).\n- L50 (Niveau MÃ©dian): Le niveau sonore moyen ressenti la majoritÃ© du temps.\n- L90 (Bruit de Fond): Niveau dÃ©passÃ© 90% du temps. ReprÃ©sente le calme rÃ©siduel de l'environnement (ce qu'il reste quand tout s'arrÃªte).\n\nCes valeurs permettent de distinguer les pics du niveau ambiant rÃ©siduel.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "dark-red",
            "mode": "fixed"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byRegexp",
              "options": "/.*L10.*/"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L10 (Pics)"
              }
            ]
          },
          {
            "matcher": {
              "id": "byRegexp",
              "options": "/.*L50.*/"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L50 (MÃ©diane)"
              }
            ]
          },
          {
            "matcher": {
              "id": "byRegexp",
              "options": "/.*L90.*/"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L90 (Bruit de fond)"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 11,
        "w": 24,
        "x": 0,
        "y": 173
      },
      "id": 10,
      "options": {
        "displayMode": "lcd",
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": false
        },
        "maxVizHeight": 300,
        "minVizHeight": 16,
        "minVizWidth": 8,
        "namePlacement": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [],
          "fields": "",
          "values": false
        },
        "showUnfilled": true,
        "sizing": "auto",
        "valueMode": "color"
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"math\"\nimport \"timezone\"\noption location = timezone.location(name: \"Europe/Brussels\")\n\ndata = from(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\")\n  |> filter(fn: (r) => r[\"_field\"] == \"spl\")\n  |> group() \n\nl10 = data\n  |> quantile(q: 0.90)\n  |> map(fn: (r) => ({ _field: \"L10 (Pics)\", _value: math.round(x: r._value) }))\n\nl50 = data\n  |> quantile(q: 0.50)\n  |> map(fn: (r) => ({ _field: \"L50 (MÃ©diane)\", _value: math.round(x: r._value) }))\n\nl90 = data\n  |> quantile(q: 0.10)\n  |> map(fn: (r) => ({ _field: \"L90 (Bruit de fond)\", _value: math.round(x: r._value) }))\n\nunion(tables: [l10, l50, l90])\n  |> group(columns: [\"_field\"])\n  |> yield(name: \"acoustic_stats\")",
          "refId": "A"
        }
      ],
      "title": "Signature Acoustique Globale (L10 / L50 / L90)",
      "type": "bargauge"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Calcul de la dynamique du bruit: DiffÃ©rence entre le niveau de pointe (L10) et le niveau de fond (L90).\n\n- Valeur Ã©levÃ©e (> 15 dB) : Bruit fluctuant, trafic, Ã©vÃ©nements ponctuels.\n- Valeur faible (< 5 dB) : Bruit monotone et continu. C'est la signature typique d'une **Pompe Ã  Chaleur** ou d'une VMC.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "text",
            "mode": "fixed",
            "seriesBy": "last"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "opacity",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": true,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "dashed+area"
            }
          },
          "displayName": "Indice de Monotonie",
          "fieldMinMax": false,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              },
              {
                "color": "dark-orange",
                "value": 5
              },
              {
                "color": "dark-red",
                "value": 15
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byFrameRefID",
              "options": "B"
            },
            "properties": [
              {
                "id": "mappings",
                "value": [
                  {
                    "options": {
                      "from": 0,
                      "result": {
                        "color": "dark-green",
                        "index": 0,
                        "text": "Stable"
                      },
                      "to": 5
                    },
                    "type": "range"
                  },
                  {
                    "options": {
                      "from": 5,
                      "result": {
                        "color": "dark-orange",
                        "index": 1,
                        "text": "Fluctuant"
                      },
                      "to": 15
                    },
                    "type": "range"
                  },
                  {
                    "options": {
                      "from": 15,
                      "result": {
                        "color": "dark-red",
                        "index": 2,
                        "text": "Hautement variable"
                      },
                      "to": 100
                    },
                    "type": "range"
                  }
                ]
              },
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 9,
        "w": 24,
        "x": 0,
        "y": 184
      },
      "id": 22,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\n// Configuration de la zone horaire\noption location = timezone.location(name: \"Europe/Brussels\")\n\n// 1. RÃ©cupÃ©ration et nettoyage des donnÃ©es\ndata = from(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> filter(fn: (r) => exists r._value) // On ignore les points vides\n\n// 2. Calcul du L10 (Pics sonores)\nl10 = data \n  |> aggregateWindow(every: 30m, fn: (column, tables=<-) => tables |> quantile(q: 0.90), createEmpty: false)\n\n// 3. Calcul du L90 (Bruit de fond)\nl90 = data \n  |> aggregateWindow(every: 30m, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n\njoin(tables: {l10: l10, l90: l90}, on: [\"_time\"])\n  |> map(fn: (r) => {\n      // Calcul de la diffÃ©rence brute\n      raw_diff = r._value_l10 - r._value_l90\n      \n      // Correction : Si nÃ©gatif (erreur de calcul), on ramÃ¨ne Ã  0\n      val = if raw_diff < 0.0 then 0.0 else raw_diff\n      \n      return {\n          _time: r._time,\n          _value: val,\n          _field: \"Climat Sonore (L10-L90)\"\n      }\n  })",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\n// Configuration de la zone horaire\noption location = timezone.location(name: \"Europe/Brussels\")\n\n// 1. RÃ©cupÃ©ration et nettoyage des donnÃ©es\ndata = from(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> filter(fn: (r) => exists r._value) // On ignore les points vides\n\n// 2. Calcul du L10 (Pics sonores)\nl10 = data \n  |> aggregateWindow(every: 30m, fn: (column, tables=<-) => tables |> quantile(q: 0.90), createEmpty: false)\n\n// 3. Calcul du L90 (Bruit de fond)\nl90 = data \n  |> aggregateWindow(every: 30m, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n\njoin(tables: {l10: l10, l90: l90}, on: [\"_time\"])\n  |> map(fn: (r) => {\n      // Calcul de la diffÃ©rence brute\n      raw_diff = math.round(x: r._value_l10 - r._value_l90)\n      \n      // Correction : Si nÃ©gatif (erreur de calcul), on ramÃ¨ne Ã  0\n      val = if raw_diff < 0.0 then 0.0 else raw_diff\n      \n      return {\n          _time: r._time,\n          _value: val,\n          _field: \"Variability\"\n      }\n  })",
          "refId": "B"
        }
      ],
      "title": "Signature du Bruit: Dynamique & Monotonie",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Affiche la position du capteur Ã  partir de coordonnÃ©es dÃ©finies dans le tableau de bord (point fixe). Sert Ã  interprÃ©ter les mesures en fonction de lâ€™environnement immÃ©diat (obstacles, voisinage, gÃ©omÃ©trie des lieux).",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 11,
        "w": 24,
        "x": 0,
        "y": 193
      },
      "id": 5,
      "options": {
        "basemap": {
          "config": {},
          "name": "Layer 0",
          "noRepeat": false,
          "type": "default"
        },
        "controls": {
          "mouseWheelZoom": true,
          "showAttribution": true,
          "showDebug": false,
          "showMeasure": false,
          "showScale": false,
          "showZoom": true
        },
        "layers": [
          {
            "config": {
              "blur": 50,
              "radius": 50,
              "weight": {
                "fixed": 1,
                "max": 1,
                "min": 0
              }
            },
            "filterData": {
              "id": "byRefId",
              "options": "A"
            },
            "layer-tooltip": true,
            "location": {
              "mode": "auto"
            },
            "name": "Layer 1",
            "opacity": 0.5,
            "tooltip": true,
            "type": "heatmap"
          }
        ],
        "tooltip": {
          "mode": "details"
        },
        "view": {
          "allLayers": true,
          "id": "coords",
          "lat": 50.599922,
          "lon": 4.32828,
          "noRepeat": false,
          "zoom": 17.78
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"array\"\n\narray.from(rows: [{\n    lat: 50.599724, \n    lon: 4.328188, \n    location_name: \"ExtÃ©rieur, Jardin\",\n    sensor_type: \"Trotec SL400\"\n}])",
          "refId": "A"
        }
      ],
      "title": "Localisation du Capteur",
      "type": "geomap"
    }
  ],
  "preload": false,
  "refresh": "auto",
  "schemaVersion": 42,
  "tags": [],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-3h",
    "to": "now"
  },
  "timepicker": {
    "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "4h", "1d", "2d", "7d"]
  },
  "timezone": "browser",
  "title": "Noise Station",
  "uid": "adx4w44",
  "version": 1,
  "weekStart": "monday"
}
