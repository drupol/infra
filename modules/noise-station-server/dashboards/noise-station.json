{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": 85,
  "links": [],
  "liveNow": true,
  "panels": [
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 11,
      "panels": [],
      "title": "A propos de Noise Station et réglementation en Région Wallonne",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 31,
        "w": 12,
        "x": 0,
        "y": 1
      },
      "id": 6,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "# Noise Station\n\n### Un système de monitoring acoustique intelligent\n\nLa **Noise Station** est une solution de surveillance environnementale de haute précision conçue pour capturer, analyser et visualiser les niveaux sonores d'un espace en temps réel. Elle transforme des données acoustiques brutes en indicateurs visuels pour suivre l'évolution du bruit, détecter les pics et comprendre le profil sonore d'un lieu sur 24 heures.\n\n# Comment ça fonctionne ?\n\n### 1. La Capture (Le Matériel)\n\nLe système s'appuie sur un microphone professionnel de type **Trotec SL400** (équivalent du **CEM DT-8852**). Ce sonomètre de Classe 2 offre des fonctionnalités indispensables :\n-   **Double Pondération:** Supporte les courbes **dB(A)** (perception humaine) et **dB(C)** (basses fréquences).\n-   **Plage Dynamique:** Mesure précise de 30 à 130 dB (précision : 1,4 dB, résolution : 0,1 dB)\n-   **Modes Temporels:** Analyse en mode \"Fast\" (réactivité immédiate) ou \"Slow\" (stabilité).\n-   **Signaux numériques:** Uniquement les données numériques (et pas analogique) sont transmises. \n-   **Certification:** Livré avec certificat de calibration, conforme à IEC61672-1 Class 2\n\n### 2. Le Cœur du Système (L'Intelligence)\n\nLes données sont traitées par une unité de calcul (**Raspberry Pi**) et stockées dans une base de données temporelle (**InfluxDB**):\n*   **Nettoyage :** Filtrage des métadonnées pour une lecture fluide.\n*   **Agrégation :** Calcul de statistiques avancées (L10, L50, L90) en temps réel.\n\n### 3. La Visualisation (Le Dashboard)\n\nLe dashboard utilise plusieurs méthodes d'analyse pour une vue complète :\n\n*   **Vue Temps Réel (Conformité) :** Vérifie si le **niveau médian (L50)** respecte les seuils légaux (40/45/50 dB). Il colore le graphe en rouge si un dépassement persiste plus de **2 minutes**, ce qui permet de distinguer une nuisance réelle (ex: pompe à chaleur) d'un bruit passager (ex: avion).\n*   **Conformité (Analyse des Émergences) :** Un graphique comparant le niveau médian (**L50**) aux seuils réglementaires pour identifier les dépassements durables.\n*   **Indicateurs de Pression Acoustique (Tableau de Bord)** : Un résumé statistique complet affichant le SEL (Exposition Totale), le **Lden** (Pondération Jour/Soir/Nuit) et les percentiles (L10/L50/L90) pour une lecture rapide de la situation.\n*   **Profil Acoustique (Expert) :** Une analyse fine comparant le standard légal (Leq) et la réalité ressentie (L50) pour identifier la nature du bruit (machine vs trafic).\n*   **Indice de Monotonie :** Un calcul mathématique (L10-L90) qui détermine si le bruit est *stable* (typique d'une installation industrielle) ou *aléatoire*.\n*   **Pic de Volume (Volume Maximum Enregistré) :** Une jauge dynamique qui surveille le volume maximal atteint durant la **période affichée**.\n*   **Profil Statistique (Fréquence Sonore) :** Un histogramme qui regroupe les mesures des dernières 24 heures par paliers de décibels.\n*   **Distribution Horaire :** Un graphique affichant la **moyenne sonore pour chaque heure**.\n*   **Géolocalisation :** Une carte intégrée affichant l'emplacement précis du capteur.\n\n# Pourquoi utiliser Noise Station ?\n\nPasser du ressenti subjectif (\"c'est bruyant\") à une mesure objective (\"la moyenne est de 65 dB avec des pics à 85 dB\"). Que ce soit pour le confort au travail, la surveillance de voisinage ou l'analyse environnementale, la **Noise Station** fournit une preuve scientifique et visuelle de la réalité acoustique de votre environnement.",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 11,
        "w": 12,
        "x": 12,
        "y": 1
      },
      "id": 7,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "En Région Wallonne (https://www.ejustice.just.fgov.be/eli/arrete/2002/07/04/2002027815/justel), le cadre légal est clair et rigoureux. Depuis l’arrêté du Gouvernement wallon du 4 juillet 2022, des limites de bruit spécifiques s’appliquent aux PAC selon les différentes périodes de la journée :\n\n- En journée (7h-19h): le bruit ne doit pas dépasser 50 dB.\n- En transition (6h-7h, 19h-22h): la limite est réduite à 45 dB.\n- La nuit (22h-6h): le niveau sonore doit impérativement rester sous 40 dB.\n\nLe bruit se propage en cercle autour d'une unité extérieure (PAC). \nIl est donc crucial de faire attention aux surfaces environnantes, comme des murs ou d’autres bâtiments, qui peuvent réfléchir le son et provoquer un effet d’écho. Pour limiter cette résonance, maintenez au moins un mètre d’espace autour de la pompe, en particulier par rapport aux fenêtres, aux portes et aux chemins. Si l’unité est placée contre un mur, veillez à respecter une distance minimale de 30 centimètres — l’idéal étant de 50 centimètres — pour garantir une circulation sonore optimale. Il est également important de prendre en compte la distance entre la face avant de la pompe à chaleur et les trottoirs, qui doit être d’au moins 3 mètres et d’au moins 6 mètres pour les plantes.\n\nSource: https://www.bobex.be/fr-be/pompe-a-chaleur/installation/distance-voisin/\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "Réglementation en Région Wallonne",
      "type": "text"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 20,
        "w": 12,
        "x": 12,
        "y": 12
      },
      "id": 25,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Les niveaux sonores présentés sont exprimés en décibels selon des pondérations fréquentielles normalisées.\n\nLa pondération dB(A) est définie afin de reproduire la sensibilité moyenne de l’oreille humaine et constitue la référence réglementaire utilisée par les autorités compétentes pour l’évaluation du respect des seuils légaux de bruit. Elle atténue significativement les basses fréquences, ce qui peut conduire à une sous-évaluation de certaines nuisances d’origine mécanique.\n\nLa pondération dB(C), plus linéaire sur l’ensemble du spectre audible, permet de mesurer l’énergie acoustique globale, y compris les basses fréquences. Elle est particulièrement pertinente pour l’analyse de nuisances sonores persistantes à dominante grave, telles que celles générées par des équipements techniques fixes, notamment les pompes à chaleur.\n\nL’utilisation conjointe et complémentaire de ces deux pondérations permet ainsi de distinguer la conformité réglementaire d’une part, et la réalité de la gêne acoustique subie d’autre part.\n\n---\n\n**Note sur le Leq et la linéarité** : Le **Leq** (Niveau Continu Équivalent) est une mesure \"linéaire\" dans le temps, c'est-à-dire qu'il n'applique pas de pondération temporelle (comme \"Fast\" ou \"Slow\"). Il intègre l'énergie totale sur la période de mesure de manière égale. C'est ce qui le distingue d'une simple lecture instantanée de sonomètre.",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "Pondérations acoustiques dB(A) et dB(C)",
      "type": "text"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 32
      },
      "id": 16,
      "panels": [],
      "title": "Surveillance en Temps Réel et Conformité",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 20,
        "w": 24,
        "x": 0,
        "y": 33
      },
      "id": 17,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Cette section met en regard le **niveau sonore médian (L50)** et les **seuils réglementaires applicables en Région Wallonne**.\n\n### Vue en Temps Réel\n\nLe panneau *Vue en Temps Réel* est un outil de **contrôle de conformité** direct. Il part des mesures SPL brutes et applique la logique suivante :\n\n1. **Calcul de la Médiane Lissée (L50)** : Bien que la réglementation se base sur le **Leq** (Moyenne Énergétique), nous utilisons ici le **L50** (Médiane Statistiques) pour l'affichage temps réel. Cela permet de filtrer naturellement les pics d'énergie brefs (voitures, avions) pour se concentrer sur le niveau sonore *typique* et constant (la nuisance de la PAC).\n2. **Comparaison Légale** : Chaque point est comparé à la limite autorisée selon l'heure (50dB jour / 45dB transition / 40dB nuit).\n3. **Détection d'Infraction** : Si le niveau dépasse la limite, le système vérifie la **durée** du dépassement.\n    *   **OK (Vert)** : Le niveau est conforme.\n    *   **En attente (Rouge)** : Le niveau dépasse le seuil, mais depuis moins de 2 minutes (tolérance technique).\n    *   **NOK (Rouge)** : Le dépassement est confirmé car il dure depuis plus de **2 minutes**. C'est une infraction potentielle.\n\nCette méthode permet de filtrer les pics brefs pour ne signaler que les dépassements significatifs.\n\n### Historique des Infractions\n\nCe panneau binaire enregistre les moments où le bruit a été jugé comme une nuisance (Infraction confirmée > 2 min). C'est l'historique officiel des non-conformités.\n\n### Analyse des Émergences\n\nLe graphique *Analyse des Émergences : Conformité aux Seuils Légaux* (plus bas) compare le niveau médian (**L50**) aux seuils réglementaires. Il met en évidence les périodes et l'intensité des dépassements par rapport à la limite autorisée (40/45/50 dB).\n\n### Taux de Dépassement des Seuils Légaux\n\nCet indicateur mesure la fréquence de l'exposition aux nuisances sonores plutôt que leur intensité brute. Une valeur de 0 % indique une conformité parfaite sur la période sélectionnée, tandis qu'une valeur élevée signale des dépassements fréquents ou continus.\n\nLe calcul est basé sur une pondération dynamique des seuils de tolérance :\n\n- Période de Jour (07:00 - 19:00) : Seuil de 50 dB.\n- Période de Transition (06:00 - 07:00 & 19:00 - 22:00) : Seuil de 45 dB.\n- Période de Nuit (22:00 - 06:00) : Seuil de 40 dB.\n\nLe pourcentage obtenu représente le ratio entre le nombre de relevés en infraction et le nombre total de mesures effectuées.\n\nCet indicateur est essentiel pour évaluer l'impact sonore global sur le voisinage et la récurrence des épisodes de bruit excessif.",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Affiche le SPL reconstruit sur des fenêtres de 30s à partir des mesures: conversion dB→énergie, agrégation en énergie, puis reconversion en dB. La courbe est comparée à une limite réglementaire dynamique (40/45/50 dB) calculée à partir de l’heure locale. NOTE: Cette visualisation applique une moyenne mobile exponentielle (n=30) pour lisser les courbes et faciliter la lecture. Pour une expertise acoustique stricte, il est recommandé d'analyser les valeurs brutes.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "green",
            "mode": "fixed",
            "seriesBy": "last"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineStyle": {
              "fill": "solid"
            },
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "displayName": "Niveau Sonore - L50 (${__field.labels.frequency_weighting})",
          "fieldMinMax": false,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "nok"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-red",
                  "mode": "fixed"
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 20
              },
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byFrameRefID",
              "options": "Seuil Légal"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#ccccdbbf",
                  "mode": "fixed"
                }
              },
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [10, 10],
                  "fill": "dash"
                }
              },
              {
                "id": "displayName",
                "value": "Seuil Légal"
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "pending"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-red",
                  "mode": "fixed"
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 20
              },
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": false
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "ok"
            },
            "properties": [
              {
                "id": "custom.fillOpacity",
                "value": 20
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "excess"
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              },
              {
                "id": "displayName",
                "value": "Dépassement"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "text",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "real_value"
            },
            "properties": [
              {
                "id": "custom.lineStyle",
                "value": {
                  "fill": "solid"
                }
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "#4457704d",
                  "mode": "fixed"
                }
              },
              {
                "id": "displayName",
                "value": "Niveau Sonore Brut (${__field.labels.frequency_weighting})"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 15,
        "w": 24,
        "x": 0,
        "y": 53
      },
      "id": 1,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"date\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nminSeconds = 120\n\n// 1. On récupère la valeur médiane brute (Source)\nsourceData =\n  from(bucket: \"default\")\n    |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n    |> filter(fn: (r) => r._measurement == \"dt8852\" and r._field == \"spl\")\n    |> keep(columns: [\"_time\", \"_value\", \"frequency_weighting\"])\n    |> aggregateWindow(\n        every: v.windowPeriod,\n        fn: (column, tables=<-) => tables |> quantile(q: 0.50),\n        createEmpty: false\n      )\n\nemaData = \n  sourceData \n    |> exponentialMovingAverage(n: 30)\n\ncombined = \n  union(tables: [\n    sourceData |> map(fn: (r) => ({ r with _field: \"val_raw\" })),\n    emaData |> map(fn: (r) => ({ r with _field: \"val_ema\" }))\n  ])\n  |> pivot(rowKey: [\"_time\", \"frequency_weighting\"], columnKey: [\"_field\"], valueColumn: \"_value\")\n  |> map(fn: (r) => {\n        h = date.hour(t: r._time)\n        limitValue =\n          if h >= 7 and h < 19 then 50.0\n          else if (h >= 6 and h < 7) or (h >= 19 and h < 22) then 45.0\n          else 40.0\n        \n        return { r with \n            limit: limitValue,\n            exceed_decision: r.val_ema > limitValue \n        }\n  })\n  |> stateDuration(fn: (r) => r.exceed_decision, column: \"exceed_seconds\", unit: 1s)\n  |> map(fn: (r) => {\n        status = if not r.exceed_decision then \"ok\"\n                 else if r.exceed_seconds >= minSeconds then \"nok\"\n                 else \"pending\"\n        \n        return { r with\n            status: status,\n            excess_raw: (r.val_raw - r.limit)\n        }\n  })\n\nstatusSeries = combined |> map(fn: (r) => ({ _time: r._time, frequency_weighting: r.frequency_weighting, _field: r.status, _value: r.val_ema }))\nrealSeries   = combined |> map(fn: (r) => ({ _time: r._time, frequency_weighting: r.frequency_weighting, _field: \"real_value\", _value: r.val_raw }))\nexcessSeries = combined |> map(fn: (r) => ({ \n    _time: r._time, \n    frequency_weighting: r.frequency_weighting, \n    _field: \"excess\", \n    _value: if r.excess_raw > 0.0 then r.excess_raw else 0.0 \n}))\n\nunion(tables: [statusSeries, realSeries, excessSeries])\n  |> group(columns: [\"frequency_weighting\", \"_field\"])\n  |> pivot(rowKey: [\"_time\", \"frequency_weighting\"], columnKey: [\"_field\"], valueColumn: \"_value\")",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"date\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"dt8852\" and r._field == \"spl\")\n  |> aggregateWindow(every: v.windowPeriod, fn: first)\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      return {\n          _time: r._time,\n          _limit: if h >= 7 and h < 19 then 50.0 \n                  else if h == 6 or (h >= 19 and h < 22) then 45.0 \n                  else 40.0\n      }\n  })",
          "refId": "Seuil Légal"
        }
      ],
      "timeFrom": "now-1d",
      "title": "Vue en Temps Réel",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Encode la conformité temporelle. Les données SPL sont agrégées, puis comparées à la limite horaire (40/45/50 dB). Une infraction est comptabilisée si le dépassement persiste plus de 2 minutes.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisPlacement": "auto",
            "fillOpacity": 70,
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineWidth": 0,
            "spanNulls": false
          },
          "mappings": [
            {
              "options": {
                "0": {
                  "color": "dark-green",
                  "index": 0,
                  "text": "Conforme"
                },
                "1": {
                  "color": "dark-red",
                  "index": 1,
                  "text": "Infraction"
                }
              },
              "type": "value"
            }
          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Value"
            },
            "properties": [
              {
                "id": "custom.axisPlacement",
                "value": "hidden"
              },
              {
                "id": "displayName",
                "value": "Conformité"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 4,
        "w": 24,
        "x": 0,
        "y": 68
      },
      "id": 8,
      "options": {
        "alignValue": "left",
        "legend": {
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "mergeValues": true,
        "rowHeight": 0.9,
        "showValue": "never",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"dt8852\" and r._field == \"spl\")\n  |> filter(fn: (r) => exists r._value)\n  |> filter(fn: (r) => exists r.time_weighting)  \n  |> aggregateWindow(\n      every: 60s,\n      fn: (column, tables=<-) => tables |> quantile(q: 0.90, column: column),\n      createEmpty: false\n  )\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n\n      limit =\n        if h >= 7 and h < 19 then 50.0\n        else if (h >= 6 and h < 7) or (h >= 19 and h < 22) then 45.0\n        else 40.0\n\n      return {\n        _time: r._time,\n        _value: if r._value > limit then 1.0 else 0.0,\n        is_violation: if r._value > limit then 1 else 0\n      }\n  })\n  |> stateDuration(fn: (r) => r.is_violation == 1, column: \"duration\", unit: 1s)\n  |> map(fn: (r) => ({\n      _time: r._time,\n      _value: if r.is_violation == 1 and r.duration >= 120 then 1.0 else 0.0\n  }))",
          "refId": "A"
        }
      ],
      "timeFrom": "now-1d",
      "title": "Historique des Infractions",
      "type": "state-timeline"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Suivi en temps réel du dépassement des limites acoustiques réglementaires (50/45/40 dB) avec détection automatique des périodes Jour, Aube, Soir et Nuit.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "dark-red",
            "mode": "fixed"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 50,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineStyle": {
              "fill": "solid"
            },
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "seuil_legal"
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": false
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": 0
                    },
                    {
                      "color": "dark-orange",
                      "value": 45
                    },
                    {
                      "color": "dark-red",
                      "value": 50
                    }
                  ]
                }
              },
              {
                "id": "color",
                "value": {
                  "mode": "thresholds",
                  "seriesBy": "last"
                }
              },
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [10, 10],
                  "fill": "dash"
                }
              },
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              },
              {
                "id": "displayName",
                "value": "Seuil Légal"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "niveau_reel"
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              },
              {
                "id": "displayName",
                "value": "Niveau Sonore Brut"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "_value"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Dépassement"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 18,
        "x": 0,
        "y": 72
      },
      "id": 23,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"math\"\nimport \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> filter(fn: (r) => exists r._value)\n  \n  //|> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)\n  |> aggregateWindow(every: v.windowPeriod, fn: (column, tables=<-) => tables |> quantile(q: 0.50), createEmpty: false)\n  // 3. Calcul des limites horaires et du dépassement\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      \n      // Seuils réglementaires (50 / 45 / 40 dB)\n      limite = if h >= 7 and h < 19 then 50.0 \n               else if (h >= 6 and h < 7) or (h >= 19 and h < 22) then 45.0 \n               else 40.0\n      \n      // Calcul du dépassement\n      diff = if r._value > limite then r._value - limite else 0.0\n      \n      return {\n          _time: r._time,\n          _value: diff,\n          _field: \"Dépassement\",\n          niveau_reel: r._value,\n          seuil_legal: limite\n      }\n  })\n  \n  // 4. Envoi des données vers Grafana\n  |> yield(name: \"depassement_acoustique\")",
          "refId": "A"
        }
      ],
      "timeFrom": "now-1d",
      "title": "Analyse des Émergences : Conformité aux Seuils Légaux",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Ce panel affiche la proportion de temps (en %) durant laquelle le niveau de pression acoustique (SPL) a excédé les limites réglementaires définies pour la zone. Le calcul tient compte de la variation des seuils selon l'heure : 50 dB (Jour), 45 dB (Aube/Soir/Transition) et 40 dB (Nuit).",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-orange",
                "value": 0
              },
              {
                "color": "#EAB839",
                "value": 5
              },
              {
                "color": "dark-red",
                "value": 10
              },
              {
                "color": "dark-red",
                "value": 20
              },
              {
                "color": "dark-red",
                "value": 30
              },
              {
                "color": "dark-red",
                "value": 40
              },
              {
                "color": "dark-red",
                "value": 50
              },
              {
                "color": "dark-red",
                "value": 60
              },
              {
                "color": "dark-red",
                "value": 70
              },
              {
                "color": "dark-red",
                "value": 80
              },
              {
                "color": "dark-red",
                "value": 90
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 6,
        "x": 18,
        "y": 72
      },
      "id": 29,
      "options": {
        "minVizHeight": 75,
        "minVizWidth": 75,
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": true,
        "showThresholdMarkers": true,
        "sizing": "auto"
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\ndata = from(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> filter(fn: (r) => exists r._value)\n  |> filter(fn: (r) => exists r.time_weighting)\n  // On réduit d'abord la densité des données pour éviter d'essouffler le map()\n  // 'v.windowPeriod' s'adapte automatiquement à la plage sélectionnée dans Grafana\n  |> aggregateWindow(every: v.windowPeriod, fn: mean) \n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      limite = if h >= 7 and h < 19 then 50.0 \n               else if (h >= 6 and h < 7) or (h >= 19 and h < 22) then 45.0 \n               else 40.0\n      \n      return { r with _value: if r._value > limite then 1.0 else 0.0 }\n  })\n  |> mean()\n  |> map(fn: (r) => ({ r with _value: r._value * 100.0 }))\n  |> yield(name: \"pourcentage_depassement\")",
          "refId": "A"
        }
      ],
      "title": "Taux de Dépassement des Seuils Légaux",
      "type": "gauge"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 80
      },
      "id": 20,
      "panels": [],
      "title": "Indicateurs Experts et Contexte",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 18,
        "w": 24,
        "x": 0,
        "y": 81
      },
      "id": 21,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Cette section complète la surveillance temps réel par une analyse approfondie de l'environnement sonore. Elle permet de qualifier le type de bruit et d'évaluer la gêne globale.\n\n### 1. Synthèse Avancée (Tableau Statistique)\n\nCe panneau offre une vue exhaustive des indicateurs acoustiques sur la période sélectionnée :\n\n*   **Lden (Day-Evening-Night)** : Moyenne pondérée qui pénalise le bruit en **soirée (+5 dB)** et la **nuit (+10 dB)**. C'est l'indicateur de référence pour évaluer la gêne à long terme.\n*   **SEL (Sound Exposure Level)** : La \"dose\" totale de bruit accumulée. Utile pour comparer des événements de durées différentes.\n*   **Leq (Niveau Continu Équivalent)** : La moyenne énergétique classique (référence légale).\n*   **Percentiles (L10 / L50 / L90)** :\n    *   **L10 (Les Pics)** : Niveau dépassé 10% du temps. Représente les bruits forts intermittents.\n    *   **L50 (La Médiane)** : Niveau dépassé 50% du temps. Représente le bruit \"typique\".\n    *   **L90 (Le Fond)** : Niveau dépassé 90% du temps. Représente le calme résiduel.\n\n### 2. Indicateurs de Pression Acoustique (Graphique Temporel)\n\nCe graphique montre **l'évolution temporelle** des indicateurs (L10, L50, L90) par rapport au niveau brut (SPL) et aux seuils. Il permet de visualiser la dynamique instantanée du bruit :\n*   **Lignes pointillées (L10/L90)** : Délimitent l'enveloppe du bruit (Max / Min).\n*   **Ligne continue (L50)** : Montre la tendance centrale.\n*   **Zones colorées** : Indiquent les périodes de conformité (Vert) ou de dépassement (Rouge) par rapport aux seuils horaires.\n\n### 3. Synthèse Acoustique Quotidienne: Indicateurs d'Impact et de Nuisance\n\nCette visualisation offre une analyse complète de l'environnement sonore sur une base de 24 heures. L'indicateur Lden (Level Day-Evening-Night) évalue la nuisance globale en appliquant des pénalités de +5 dB le soir et +10 dB la nuit, reflétant la sensibilité accrue des riverains. La structure du bruit est détaillée par les percentiles : le L10 capture les événements sonores émergents (pics), le L50 représente le niveau médian, et le L90 définit le bruit de fond résiduel. Pour une fiabilité maximale, les valeurs Lmin et Lmax sont extraites des données brutes à la seconde pour identifier les événements extrêmes, tandis que les moyennes énergétiques et statistiques sont calculées par échantillonnage haute fréquence afin d'assurer une robustesse métrologique optimale.\n\n### 4. Signature du Bruit (Graphique Dynamique & Monotonie)\n\nCe graphique suit l'évolution de **l'Indice de Monotonie** (différence L10 - L90), une clé essentielle pour identifier la source du bruit :\n\n*   **< 5 dB (Stable / Monotone)** : L'écart entre le fond et les pics est faible. C'est la signature typique d'une **machine tournant en continu** (Pompe à Chaleur, VMC).\n*   **5 à 15 dB (Fluctuant)** : Bruit \"vivant\" standard.\n*   **> 15 dB (Impulsif / Variable)** : L'écart est grand. Signe d'un environnement marqué par des passages de véhicules, d'avions ou des événements ponctuels.\n\n### 5. Localisation du Capteur\n\nCarte de situation du point de mesure. Ce contexte est important pour comprendre la propagation du son (distance aux sources, présence d'obstacles, réflexion sur les façades).\n\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Synthèse avancée de l'environnement sonore et analyse statistique des indicateurs acoustiques. Ce panneau présente une vue exhaustive de la pollution sonore sur la période sélectionnée en combinant mesures énergétiques et distribution centile. Il calcule le niveau moyen Leq ainsi que l'indice de gêne global Lden, lequel intègre les pénalités réglementaires pour le soir (+5 dB) et la nuit (+10 dB) conformément aux normes d'évaluation de l'exposition au bruit. L'analyse statistique par centiles permet de caractériser précisément la nature du signal : le  L10 (niveau dépassé pendant 10 % de la période) met en évidence les événements sonores ponctuels et les pics de pollution, le L50 (niveau médian dépassé 50 % du temps) définit la tendance centrale du climat sonore, tandis que le L90 (niveau dépassé 90 % du temps) permet d'isoler le bruit de fond permanent en l'absence de sources intermittentes. Enfin, le panneau affiche le niveau d'exposition unique (SEL) et les extrema (Lmax/Lmin) pour offrir une lecture complète de la dynamique acoustique du site.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "text",
            "mode": "fixed"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "L10 {frequency_weighting=\"dB(A)\", time_weighting=\"Slow\"}"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L10 (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "L50 {frequency_weighting=\"dB(A)\", time_weighting=\"Slow\"}"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L50 (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "L90 {frequency_weighting=\"dB(A)\", time_weighting=\"Slow\"}"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L90 (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Leq {frequency_weighting=\"dB(A)\", time_weighting=\"Slow\"}"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Leq (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Lmax {frequency_weighting=\"dB(A)\", time_weighting=\"Slow\"}"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Lmax (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Lmin {frequency_weighting=\"dB(A)\", time_weighting=\"Slow\"}"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Lmin (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "SEL {frequency_weighting=\"dB(A)\", time_weighting=\"Slow\"}"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "SEL (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Lden {frequency_weighting=\"dB(A)\", time_weighting=\"Slow\"}"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Lden (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 5,
        "w": 24,
        "x": 0,
        "y": 99
      },
      "id": 27,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "showPercentChange": false,
        "text": {},
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"math\"\nimport \"date\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\n// 1. Source et Agrégation Énergétique (Optimisation performance)\nraw_source = from(bucket: \"default\")\n    |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n    |> filter(fn: (r) => r._measurement == \"dt8852\" and r._field == \"spl\")\n    |> filter(fn: (r) => exists r._value)\n    |> filter(fn: (r) => exists r.time_weighting)    \n    |> group(columns: [\"frequency_weighting\", \"time_weighting\"])\n    // On convertit en énergie avant de réduire le nombre de points\n    |> map(fn: (r) => ({ r with energy: math.pow(x: 10.0, y: r._value / 10.0) }))\n    |> aggregateWindow(every: 1m, fn: mean, column: \"energy\")\n    // On garde uniquement ce qui est nécessaire pour la suite\n    |> map(fn: (r) => ({ \n        r with \n        _value: 10.0 * math.log10(x: r.energy), // Recalcul du dB moyen / min\n        hour: date.hour(t: r._time)\n    }))\n\n// 2. Calcul des statistiques\nstats_base = union(tables: [\n    raw_source |> min() |> set(key: \"_field\", value: \"min\"),\n    raw_source |> max() |> set(key: \"_field\", value: \"max\"),\n    raw_source |> quantile(q: 0.90) |> set(key: \"_field\", value: \"l10\"),\n    raw_source |> quantile(q: 0.50) |> set(key: \"_field\", value: \"l50\"),\n    raw_source |> quantile(q: 0.10) |> set(key: \"_field\", value: \"l90\"),\n    \n    raw_source \n        |> mean(column: \"energy\") \n        |> map(fn: (r) => ({ r with _value: r.energy }))\n        |> set(key: \"_field\", value: \"energy_avg\"),\n    \n    raw_source \n        |> map(fn: (r) => ({\n            r with \n            _value: if r.hour >= 7 and r.hour < 19 then r.energy \n                    else if r.hour >= 19 and r.hour < 23 then r.energy * 3.162277 // +5db\n                    else r.energy * 10.0 // +10db\n        }))\n        |> mean() \n        |> set(key: \"_field\", value: \"energy_lden_avg\")\n])\n|> map(fn: (r) => ({ r with _time: v.timeRangeStop }))\n|> pivot(rowKey:[\"_time\", \"frequency_weighting\", \"time_weighting\"], columnKey: [\"_field\"], valueColumn: \"_value\")\n\n// 3. Durée pour le SEL\nduration_sec = float(v: int(v: v.timeRangeStop) - int(v: v.timeRangeStart)) / 1000000000.0\n\n// 4. Calcul final et Nettoyage des colonnes\nstats_base\n|> map(fn: (r) => {\n    leq = 10.0 * math.log10(x: r.energy_avg)\n    lden = 10.0 * math.log10(x: r.energy_lden_avg)\n    sel = leq + (10.0 * math.log10(x: duration_sec))\n    \n    return {\n        _time: r._time,\n        frequency_weighting: r.frequency_weighting,\n        time_weighting: r.time_weighting,\n        \"Leq\": math.round(x: leq * 10.0) / 10.0,\n        \"Lden\": math.round(x: lden * 10.0) / 10.0,\n        \"L10\": math.round(x: r.l10 * 10.0) / 10.0,\n        \"L50\": math.round(x: r.l50 * 10.0) / 10.0,\n        \"L90\": math.round(x: r.l90 * 10.0) / 10.0,\n        \"Lmax\": math.round(x: r.max * 10.0) / 10.0,\n        \"Lmin\": math.round(x: r.min * 10.0) / 10.0,\n        \"SEL\": math.round(x: sel * 10.0) / 10.0\n    }\n})\n// On force InfluxDB à ne renvoyer QUE ces colonnes\n|> keep(columns: [\"_time\", \"frequency_weighting\", \"time_weighting\", \"Leq\", \"Lden\", \"L10\", \"L50\", \"L90\", \"Lmax\", \"Lmin\", \"SEL\"])\n|> yield(name: \"acoustic_indicators\")",
          "refId": "A"
        }
      ],
      "title": "Synthèse avancée de l'environnement sonore et analyse statistique des indicateurs acoustiques.",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "fixed"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineStyle": {
              "fill": "solid"
            },
            "lineWidth": 5,
            "pointSize": 10,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "seuil"
            },
            "properties": [
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [10, 10],
                  "fill": "dash"
                }
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "#80808080",
                  "mode": "fixed"
                }
              },
              {
                "id": "displayName",
                "value": "Seuil Légal"
              },
              {
                "id": "custom.lineWidth",
                "value": 1
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "L10_exced"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#c4162a40",
                  "mode": "fixed"
                }
              },
              {
                "id": "displayName",
                "value": "Niveau Sonore - L10 (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              },
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [0, 10],
                  "fill": "dot"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "L10_ok"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#37872d40",
                  "mode": "fixed"
                }
              },
              {
                "id": "displayName",
                "value": "Niveau Sonore - L10 (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              },
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [0, 10],
                  "fill": "dot"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "L50_ok"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-green",
                  "mode": "fixed"
                }
              },
              {
                "id": "displayName",
                "value": "Niveau Sonore - L50 (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "L90_exced"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#c4162a40",
                  "mode": "fixed"
                }
              },
              {
                "id": "displayName",
                "value": "Niveau Sonore - L90 (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              },
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [0, 10],
                  "fill": "dot"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "L90_ok"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#37872d40",
                  "mode": "fixed"
                }
              },
              {
                "id": "displayName",
                "value": "Niveau Sonore - L90 (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              },
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [0, 10],
                  "fill": "dot"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "L50_exced"
            },
            "properties": [
              {
                "id": "custom.lineStyle"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-red",
                  "mode": "fixed"
                }
              },
              {
                "id": "displayName",
                "value": "Niveau Sonore - L50 (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "depassement"
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              },
              {
                "id": "displayName",
                "value": "Dépassement"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 11,
        "w": 24,
        "x": 0,
        "y": 104
      },
      "id": 28,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"date\"\nimport \"timezone\"\n\n// --- CONFIGURATION ---\noption location = timezone.location(name: \"Europe/Brussels\")\n\nactualInterval = if int(v: v.windowPeriod) < int(v: 5s) then 5s else v.windowPeriod\n\nraw_data = from(bucket: \"default\")\n    |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n    |> filter(fn: (r) => r._measurement == \"dt8852\" and r._field == \"spl\")\n    |> filter(fn: (r) => exists r._value)\n    |> filter(fn: (r) => exists r.time_weighting)    \n    |> group(columns: [\"frequency_weighting\", \"time_weighting\"])\n\n// 1. On prépare la valeur \"brute\" (moyenne sur l'intervalle pour l'alignement)\nspl_raw = raw_data \n    |> aggregateWindow(every: actualInterval, fn: mean, createEmpty: false) \n    |> map(fn: (r) => ({ r with _field: \"SPL_raw\" }))\n\n// Les percentiles restent inchangés\nl10  = raw_data |> aggregateWindow(every: actualInterval, fn: (column, tables=<-) => tables |> quantile(q: 0.90), createEmpty: false) |> map(fn: (r) => ({ r with _field: \"L10\" }))\nl50  = raw_data |> aggregateWindow(every: actualInterval, fn: (column, tables=<-) => tables |> quantile(q: 0.50), createEmpty: false) |> map(fn: (r) => ({ r with _field: \"L50\" }))\nl90  = raw_data |> aggregateWindow(every: actualInterval, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false) |> map(fn: (r) => ({ r with _field: \"L90\" }))\n\n// 2. Union avec la valeur brute incluse\nunion(tables: [l10, l50, l90, spl_raw])\n    |> pivot(rowKey: [\"_time\", \"frequency_weighting\", \"time_weighting\"], columnKey: [\"_field\"], valueColumn: \"_value\")\n    |> map(fn: (r) => {\n        h = date.hour(t: r._time)\n        limit = if h >= 7 and h < 19 then 50.0\n                else if (h >= 6 and h < 7) or (h >= 19 and h < 22) then 45.0\n                else 40.0\n        \n        nan = float(v: \"NaN\")\n\n        return {\n            _time: r._time,\n            frequency_weighting: r.frequency_weighting,\n            time_weighting: r.time_weighting,\n            seuil: limit,\n            \n            // --- CALCUL DU DÉPASSEMENT UNIQUE (Basé sur SPL brut) ---\n            // Si SPL_raw > limit, on renvoie la différence, sinon 0\n            depassement: if r.SPL_raw > limit then r.SPL_raw - limit else 0.0,\n\n            // Le reste de vos données pour la coloration\n            L10_ok:     if r.L10  <= limit then r.L10  else nan,\n            L10_exced:  if r.L10  > limit  then r.L10  else nan,\n            L50_ok:     if r.L50  <= limit then r.L50  else nan,\n            L50_exced:  if r.L50  > limit  then r.L50  else nan,\n            L90_ok:     if r.L90  <= limit then r.L90  else nan,\n            L90_exced:  if r.L90  > limit  then r.L90  else nan\n        }\n    })\n    |> yield(name: \"acoustic_data\")",
          "refId": "A"
        }
      ],
      "timeFrom": "now-1d",
      "title": "Indicateurs de Pression Acoustique",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Tableau de bord consolidé des niveaux de pression acoustique pondérés A, agrégés de minuit à minuit (24h). Ce rapport regroupe les indicateurs réglementaires d'exposition (Lden), la distribution statistique du bruit (L10, L50, L90) ainsi que les extrêmes de la journée (Lmin, Lmax).",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "fieldMinMax": false,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Lden"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Lden (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "L10"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L10 (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "L50"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L50 (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "L90"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L90 (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Lmax"
            },
            "properties": [
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [10, 10],
                  "fill": "dash"
                }
              },
              {
                "id": "custom.pointSize",
                "value": 10
              },
              {
                "id": "displayName",
                "value": "Lmax (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Lmin"
            },
            "properties": [
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [10, 10],
                  "fill": "dash"
                }
              },
              {
                "id": "custom.pointSize",
                "value": 10
              },
              {
                "id": "displayName",
                "value": "Lmin (${__field.labels.frequency_weighting}, ${__field.labels.time_weighting})"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 10,
        "w": 24,
        "x": 0,
        "y": 115
      },
      "id": 30,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "desc"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"date\"\nimport \"math\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\nstartDate = 2026-01-15T07:00:00Z\nstopDate = date.truncate(t: now(), unit: 1d)\n\n// 1. CHARGEMENT ET PRÉ-RÉDUCTION (La clé de la performance)\n// On crée des \"mini-résumés\" par minute pour soulager le serveur\nsource = from(bucket: \"default\")\n  |> range(start: startDate, stop: stopDate)\n  |> filter(fn: (r) => r._measurement == \"dt8852\" and r._field == \"spl\")\n  |> filter(fn: (r) => r.frequency_weighting == \"dB(A)\")\n  |> filter(fn: (r) => exists r._value)\n  |> filter(fn: (r) => exists r.time_weighting)  \n  |> keep(columns: [\"_time\", \"_value\", \"frequency_weighting\", \"time_weighting\"])\n\n// 2. CALCULS DES EXTRÊMES (Lmin / Lmax)\n// On fait une première passe à 1m puis à 1d : c est ultra rapide\nlmax = source \n  |> aggregateWindow(every: 1m, fn: max) \n  |> aggregateWindow(every: 1d, fn: max)\n  |> map(fn: (r) => ({ r with _field: \"Lmax\" }))\n\nlmin = source \n  |> aggregateWindow(every: 1m, fn: min) \n  |> aggregateWindow(every: 1d, fn: min)\n  |> map(fn: (r) => ({ r with _field: \"Lmin\" }))\n\n// 3. PRÉPARATION POUR LE RESTE (Moyenne par minute)\n// Travailler sur des moyennes de 1m est largement suffisant pour du L10 ou LDEN journalier\nbase1m = source\n  |> aggregateWindow(every: 1m, fn: mean)\n  |> filter(fn: (r) => exists r._value)\n\n// 4. CALCUL LDEN\nlden = base1m\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      p = if h >= 7 and h < 19 then 0.0 else if h >= 19 and h < 22 then 5.0 else 10.0\n      return { r with energy: math.pow(x: 10.0, y: (float(v: r._value) + p) / 10.0) }\n  })\n  |> aggregateWindow(every: 1d, fn: mean, column: \"energy\")\n  |> map(fn: (r) => ({ \n      _time: r._time,\n      frequency_weighting: r.frequency_weighting,\n      time_weighting: r.time_weighting,\n      _field: \"Lden\", \n      _value: 10.0 * math.log10(x: r.energy) \n  }))\n\n// 5. CALCUL PERCENTILES (Sur la base 1m)\nl10 = base1m |> aggregateWindow(every: 1d, fn: (column, tables=<-) => tables |> quantile(q: 0.90)) |> map(fn: (r) => ({ r with _field: \"L10\" }))\nl50 = base1m |> aggregateWindow(every: 1d, fn: (column, tables=<-) => tables |> quantile(q: 0.50)) |> map(fn: (r) => ({ r with _field: \"L50\" }))\nl90 = base1m |> aggregateWindow(every: 1d, fn: (column, tables=<-) => tables |> quantile(q: 0.10)) |> map(fn: (r) => ({ r with _field: \"L90\" }))\n\n// 6. ASSEMBLAGE FINAL\nunion(tables: [l10, l50, l90, lmin, lmax, lden])\n  |> pivot(rowKey: [\"_time\", \"frequency_weighting\", \"time_weighting\"], columnKey: [\"_field\"], valueColumn: \"_value\")\n  |> map(fn: (r) => ({ \n      r with \n      _time: date.truncate(t: r._time, unit: 1d)\n  }))",
          "refId": "A"
        }
      ],
      "timeFrom": "now-7d",
      "title": "    Synthèse Acoustique Quotidienne: Indicateurs d'Impact et de Nuisance",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Calcul de la dynamique du bruit: Différence entre le niveau de pointe (L10) et le niveau de fond (L90).\n\n- Valeur élevée (> 15 dB) : Bruit fluctuant, trafic, événements ponctuels.\n- Valeur faible (< 5 dB) : Bruit monotone et continu. C'est la signature typique d'une **Pompe à Chaleur** ou d'une VMC.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "text",
            "mode": "thresholds",
            "seriesBy": "last"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 100,
            "gradientMode": "opacity",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": true,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "dashed"
            }
          },
          "displayName": "Indice de Monotonie",
          "fieldMinMax": false,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-red",
                "value": 0
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byFrameRefID",
              "options": "B"
            },
            "properties": [
              {
                "id": "mappings",
                "value": [
                  {
                    "options": {
                      "from": 0,
                      "result": {
                        "color": "dark-green",
                        "index": 0,
                        "text": "Stable"
                      },
                      "to": 5
                    },
                    "type": "range"
                  },
                  {
                    "options": {
                      "from": 5,
                      "result": {
                        "color": "dark-orange",
                        "index": 1,
                        "text": "Fluctuant"
                      },
                      "to": 15
                    },
                    "type": "range"
                  },
                  {
                    "options": {
                      "from": 15,
                      "result": {
                        "color": "dark-red",
                        "index": 2,
                        "text": "Hautement variable"
                      },
                      "to": 100
                    },
                    "type": "range"
                  }
                ]
              },
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 9,
        "w": 24,
        "x": 0,
        "y": 125
      },
      "id": 22,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\n// Configuration de la zone horaire\noption location = timezone.location(name: \"Europe/Brussels\")\n\n// 1. Récupération des données de base\nbase = from(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> filter(fn: (r) => exists r._value)\n\n// 2. Calcul du L10 (Pics sonores) avec renommage du champ\nl10 = base\n  |> aggregateWindow(every: 10m, fn: (column, tables=<-) => tables |> quantile(q: 0.90), createEmpty: false)\n  |> map(fn: (r) => ({ r with _field: \"l10\" }))\n\n// 3. Calcul du L90 (Bruit de fond) avec renommage du champ\nl90 = base\n  |> aggregateWindow(every: 10m, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n  |> map(fn: (r) => ({ r with _field: \"l90\" }))\n\n// 4. Fusion des tables et Pivotage pour mettre L10 et L90 sur la même ligne\nunion(tables: [l10, l90])\n  |> pivot(rowKey:[\"_time\", \"frequency_weighting\"], columnKey: [\"_field\"], valueColumn: \"_value\")\n  |> map(fn: (r) => {\n      // Calcul de la différence entre pics et bruit de fond\n      raw_diff = r.l10 - r.l90\n      \n      return {\n          _time: r._time,\n          frequency_weighting: r.frequency_weighting,\n          time_weighting: r.time_weighting,\n          _field: \"Climat Sonore (L10-L90)\",\n          _value: if raw_diff < 0.0 then 0.0 else raw_diff\n      }\n  })",
          "refId": "A"
        }
      ],
      "timeFrom": "now-1d",
      "title": "Signature du Bruit: Dynamique & Monotonie",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Affiche la position du capteur à partir de coordonnées définies dans le tableau de bord (point fixe). Sert à interpréter les mesures en fonction de l’environnement immédiat (obstacles, voisinage, géométrie des lieux).",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 11,
        "w": 24,
        "x": 0,
        "y": 134
      },
      "id": 5,
      "options": {
        "basemap": {
          "config": {},
          "name": "Layer 0",
          "noRepeat": false,
          "type": "default"
        },
        "controls": {
          "mouseWheelZoom": true,
          "showAttribution": true,
          "showDebug": false,
          "showMeasure": false,
          "showScale": false,
          "showZoom": true
        },
        "layers": [
          {
            "config": {
              "blur": 50,
              "radius": 50,
              "weight": {
                "fixed": 1,
                "max": 1,
                "min": 0
              }
            },
            "filterData": {
              "id": "byRefId",
              "options": "A"
            },
            "layer-tooltip": true,
            "location": {
              "mode": "auto"
            },
            "name": "Layer 1",
            "opacity": 0.5,
            "tooltip": true,
            "type": "heatmap"
          }
        ],
        "tooltip": {
          "mode": "details"
        },
        "view": {
          "allLayers": true,
          "id": "coords",
          "lat": 50.599922,
          "lon": 4.32828,
          "noRepeat": false,
          "zoom": 17.78
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"array\"\n\narray.from(rows: [{\n    lat: 50.599724, \n    lon: 4.328188, \n    location_name: \"Extérieur, Jardin\",\n    sensor_type: \"Trotec SL400\"\n}])",
          "refId": "A"
        }
      ],
      "title": "Localisation du Capteur",
      "type": "geomap"
    }
  ],
  "preload": false,
  "refresh": "auto",
  "schemaVersion": 42,
  "tags": [],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-3h",
    "to": "now"
  },
  "timepicker": {
    "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "4h", "1d", "2d", "7d"]
  },
  "timezone": "browser",
  "title": "Noise Station",
  "uid": "adx4w44",
  "version": 1,
  "weekStart": "monday"
}
