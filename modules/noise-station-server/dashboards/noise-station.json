{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": 47,
  "links": [],
  "liveNow": true,
  "panels": [
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 11,
      "panels": [],
      "title": "A propos de Noise Station et r√©glementation en R√©gion wallonne",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 29,
        "w": 12,
        "x": 0,
        "y": 1
      },
      "id": 6,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "# Noise Station\n\n### Un syst√®me de monitoring acoustique intelligent\n\nLa **Noise Station** est une solution de surveillance environnementale de haute pr√©cision con√ßue pour capturer, analyser et visualiser les niveaux sonores d'un espace en temps r√©el. Elle transforme des donn√©es acoustiques brutes en indicateurs visuels pour suivre l'√©volution du bruit, d√©tecter les pics et comprendre le profil sonore d'un lieu sur 24 heures.\n\n# Comment √ßa fonctionne ?\n\n### 1. La Capture (Le Mat√©riel)\n\nLe syst√®me s'appuie sur un microphone professionnel de type **Trotec SL400** (√©quivalent du **CEM DT-8852**). Ce sonom√®tre de Classe 2 offre des fonctionnalit√©s indispensables :\n-   **Double Pond√©ration:** Supporte les courbes **dB(A)** (perception humaine) et **dB(C)** (basses fr√©quences).\n-   **Plage Dynamique:** Mesure pr√©cise de 30 √† 130 dB (pr√©cision : 1,4 dB, r√©solution : 0,1 dB)\n-   **Modes Temporels:** Analyse en mode \"Fast\" (r√©activit√© imm√©diate) ou \"Slow\" (stabilit√©).\n-   **Signaux num√©riques:** Uniquement les donn√©es num√©riques (et pas analogique) sont transmises. \n-   **Certification:** Livr√© avec certificat de calibration, conforme √† IEC61672-1 Class 2\n\n### 2. Le C≈ìur du Syst√®me (L'Intelligence)\n\nLes donn√©es sont trait√©es par une unit√© de calcul (**Raspberry Pi**) et stock√©es dans une base de donn√©es temporelle (**InfluxDB**):\n*   **Nettoyage :** Filtrage des m√©tadonn√©es pour une lecture fluide.\n*   **Agr√©gation :** Calcul de statistiques avanc√©es (L10, L50, L90) en temps r√©el.\n\n### 3. La Visualisation (Le Dashboard)\n\nLe dashboard est structur√© en quatre axes compl√©mentaires pour une lecture imm√©diate :\n\n*   **Vue Temps R√©el (Live View) :** Un graphique temporel affichant le **Bruit de Fond (L90)**. Cet indicateur filtre les pics passagers (voitures, voix) pour r√©v√©ler le niveau sonore constant et permanent (la signature d'une installation technique comme une pompe √† chaleur).\n*   **Pic de Volume (Volume Maximum Enregistr√©) :** Une jauge dynamique qui surveille le volume maximal atteint durant les **5 derni√®res minutes**. Elle utilise des seuils color√©s (du vert au rouge fonc√© d√®s 80 dB) pour alerter sur les √©v√©nements sonores r√©cents.\n*   **Profil Statistique (Fr√©quence Sonore) :** Un histogramme qui regroupe les mesures des derni√®res 24 heures par paliers de d√©cibels (arrondis √† l'unit√©). Il permet de voir en un coup d'≈ìil quel niveau de bruit est le plus fr√©quent dans l'environnement.\n*   **Distribution Horaire :** Un graphique en barres affichant la **moyenne sonore pour chaque heure** de la journ√©e. Id√©al pour identifier les cycles de pollution sonore (journ√©e de travail vs nuit).\n*   **G√©olocalisation :** Une carte int√©gr√©e affichant l'emplacement pr√©cis du capteur.\n\n# Pourquoi utiliser Noise Station ?\n\nPasser du ressenti subjectif (\"c'est bruyant\") √† une mesure objective (\"la moyenne est de 65 dB avec des pics √† 85 dB\"). Que ce soit pour le confort au travail, la surveillance de voisinage ou l'analyse environnementale, la **Noise Station** fournit une preuve scientifique et visuelle de la r√©alit√© acoustique de votre environnement.",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 11,
        "w": 12,
        "x": 12,
        "y": 1
      },
      "id": 7,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "En R√©gion Wallonne (https://www.ejustice.just.fgov.be/eli/arrete/2002/07/04/2002027815/justel), le cadre l√©gal est clair et rigoureux. Depuis l‚Äôarr√™t√© du Gouvernement wallon du 4 juillet 2022, des limites de bruit sp√©cifiques s‚Äôappliquent aux PAC selon les diff√©rentes p√©riodes de la journ√©e :\n\n- En journ√©e (7h-19h): le bruit ne doit pas d√©passer 50 dB.\n- En transition (6h-7h, 19h-22h): la limite est r√©duite √† 45 dB.\n- La nuit (22h-6h): le niveau sonore doit imp√©rativement rester sous 40 dB.\n\nLe bruit se propage en cercle autour d'une unit√© ext√©rieure (PAC). \nIl est donc crucial de faire attention aux surfaces environnantes, comme des murs ou d‚Äôautres b√¢timents, qui peuvent r√©fl√©chir le son et provoquer un effet d‚Äô√©cho. Pour limiter cette r√©sonance, maintenez au moins un m√®tre d‚Äôespace autour de la pompe, en particulier par rapport aux fen√™tres, aux portes et aux chemins. Si l‚Äôunit√© est plac√©e contre un mur, veillez √† respecter une distance minimale de 30 centim√®tres ‚Äî l‚Äôid√©al √©tant de 50 centim√®tres ‚Äî pour garantir une circulation sonore optimale. Il est √©galement important de prendre en compte la distance entre la face avant de la pompe √† chaleur et les trottoirs, qui doit √™tre d‚Äôau moins 3 m√®tres et d‚Äôau moins 6 m√®tres pour les plantes.\n\nSource: https://www.bobex.be/fr-be/pompe-a-chaleur/installation/distance-voisin/\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "R√©glementation en R√©gion Wallonne",
      "type": "text"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 18,
        "w": 12,
        "x": 12,
        "y": 12
      },
      "id": 25,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Les niveaux sonores pr√©sent√©s sont exprim√©s en d√©cibels selon des pond√©rations fr√©quentielles normalis√©es.\n\nLa pond√©ration dB(A) est d√©finie afin de reproduire la sensibilit√© moyenne de l‚Äôoreille humaine et constitue la r√©f√©rence r√©glementaire utilis√©e par les autorit√©s comp√©tentes pour l‚Äô√©valuation du respect des seuils l√©gaux de bruit. Elle att√©nue significativement les basses fr√©quences, ce qui peut conduire √† une sous-√©valuation de certaines nuisances d‚Äôorigine m√©canique.\n\nLa pond√©ration dB(C), plus lin√©aire sur l‚Äôensemble du spectre audible, permet de mesurer l‚Äô√©nergie acoustique globale, y compris les basses fr√©quences. Elle est particuli√®rement pertinente pour l‚Äôanalyse de nuisances sonores persistantes √† dominante grave, telles que celles g√©n√©r√©es par des √©quipements techniques fixes, notamment les pompes √† chaleur.\n\nL‚Äôutilisation conjointe et compl√©mentaire de ces deux pond√©rations permet ainsi de distinguer la conformit√© r√©glementaire d‚Äôune part, et la r√©alit√© de la g√™ne acoustique subie d‚Äôautre part.\n\n---\n\nLa pond√©ration dB(A) permet d‚Äôappr√©cier le respect des seuils r√©glementaires applicables, tandis que la pond√©ration dB(C) constitue un indicateur pertinent de la nuisance acoustique r√©elle lorsqu‚Äôelle est domin√©e par des basses fr√©quences, notamment dans le cas d‚Äô√©quipements techniques tels qu‚Äôune pompe √† chaleur.\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "Pond√©rations acoustiques dB(A) et dB(C)",
      "type": "text"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 30
      },
      "id": 16,
      "panels": [],
      "title": "Surveillance en Temps R√©el et Conformit√©",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 28,
        "w": 24,
        "x": 0,
        "y": 31
      },
      "id": 17,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Cette section met en regard le **niveau sonore en temps r√©el** et les **seuils r√©glementaires applicables en R√©gion wallonne**.\n\n### Vue en Temps R√©el\n\nLe panneau *Vue en Temps R√©el* part des mesures **SPL** (dB) issues de la s√©rie `dt8852/spl`, puis applique le traitement suivant :\n\n1. **Extraction du Bruit de Fond (L90)** : Pour chaque fen√™tre de temps, l'algorithme retient la valeur **statistique L90** (le niveau d√©pass√© 90% du temps). Cela √©limine math√©matiquement les √©v√©nements sonores brefs (pics, voix, passage de voiture) pour ne garder que l'ambiance sonore de fond (machinerie, vent lointain).\n2. **Conversion & Lissage** : Les valeurs L90 sont converties en √©nergie, liss√©es sur 1 minute, puis reconverties en dB.\n\nCette m√©thode permet d'isoler la **signature sonore des √©quipements fixes** (ex: Pompes √† chaleur) en ignorant les bruits parasites.\n\nLes seuils de couleur sur la courbe (vert/jaune/orange/rouge) permettent d‚Äôidentifier d‚Äôun coup d‚Äô≈ìil si le niveau de fond se situe sous 40/45/50 dB, ou s‚Äôil s‚Äôen approche / les d√©passe.\n\n### Historique des Infractions\n\nUne seconde s√©rie calcule une **limite horaire** en fonction de l‚Äôheure locale (Europe/Brussels) :\n- **50 dB** entre 07h‚Äì19h  \n- **45 dB** entre 06h‚Äì07h et 19h‚Äì22h  \n- **40 dB** entre 22h‚Äì06h  \n\n### Analyse des √âmergences : Conformit√© aux Seuils L√©gaux\n\nCette visualisation est un outil de monitoring critique d√©di√© √† la **conformit√© environnementale**. Ce graphique compare directement le **Bruit de Fond (L90)** aux limites autoris√©es. \n\nL'algorithme adapte dynamiquement le seuil de tol√©rance selon l'heure locale (Europe/Bruxelles) : \n*   **50 dB** durant la journ√©e (07:00 - 19:00)\n*   **45 dB** durant les p√©riodes de transition (06:00 - 07:00 et 19:00 - 22:00)\n*   **40 dB** durant la p√©riode nocturne (22:00 - 06:00)\n\nChaque pic affich√© repr√©sente une **infraction potentielle du bruit de fond** : sa hauteur indique l'intensit√© du d√©passement en d√©cibels (dB). Un d√©passement ici signifie que le bruit est CONSTANT et sup√©rieur √† la loi.\n\n### S√©v√©rit√© des Nuisances Acoustiques\n\nCette visualisation sous forme de frise temporelle offre une lecture imm√©diate et synth√©tique de la qualit√© de l'environnement sonore sur une p√©riode donn√©e.\n\nLe syst√®me analyse chaque mesure en fonction des seuils l√©gaux variables. Lorsqu'un bruit exc√®de la limite autoris√©e, il est automatiquement classifi√© selon l'importance du d√©passement (l'√©mergence) :\n\n- Jaune / Mod√©r√© : Nuisance perceptible (5 √† 10 dB)\n- Orange / Fort : Pollution sonore marqu√©e (10 √† 15 dB)\n- Rouge / Critique : Nuisance majeure (15 √† 20 dB)\n\nCette approche permet de transformer des milliers de points de donn√©es en un calendrier visuel, id√©al pour rep√©rer des cycles de nuisances r√©currents.",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Affiche le SPL reconstruit sur des fen√™tres de 30s √† partir des mesures: conversion dB‚Üí√©nergie, agr√©gation en √©nergie, puis reconversion en dB. La courbe est compar√©e √† une limite r√©glementaire dynamique (40/45/50 dB) calcul√©e √† partir de l‚Äôheure locale.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "green",
            "mode": "thresholds",
            "seriesBy": "last"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 25,
            "gradientMode": "scheme",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineStyle": {
              "fill": "solid"
            },
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": true,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "displayName": "Sound Pressure Level L90 (${__field.labels.frequency_weighting})",
          "fieldMinMax": false,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              },
              {
                "color": "dark-yellow",
                "value": 40
              },
              {
                "color": "dark-orange",
                "value": 45
              },
              {
                "color": "dark-red",
                "value": 50
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "_limit"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Limite en R√©gion Wallonne"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "#ffffff",
                  "mode": "fixed"
                }
              },
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [10, 10],
                  "fill": "dash"
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              }
            ]
          },
          {
            "matcher": {
              "id": "byFrameRefID",
              "options": "B"
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              },
              {
                "id": "color",
                "value": {
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "D√©passement (dB)"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "D√©passement (dB)"
              },
              {
                "id": "color",
                "value": {
                  "mode": "thresholds"
                }
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": 0
                    },
                    {
                      "color": "#EAB839",
                      "value": 5
                    },
                    {
                      "color": "dark-orange",
                      "value": 10
                    },
                    {
                      "color": "dark-red",
                      "value": 15
                    },
                    {
                      "color": "dark-purple",
                      "value": 20
                    }
                  ]
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byFrameRefID",
              "options": "Live Raw"
            },
            "properties": [
              {
                "id": "custom.drawStyle",
                "value": "line"
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              },
              {
                "id": "custom.showPoints",
                "value": "always"
              },
              {
                "id": "custom.pointSize",
                "value": 2
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "#ccccdb0f",
                  "mode": "fixed"
                }
              },
              {
                "id": "displayName",
                "value": "Sound Pressure Level Raw (${__field.labels.frequency_weighting})"
              }
            ]
          },
          {
            "matcher": {
              "id": "byFrameRefID",
              "options": "A"
            },
            "properties": [
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [10, 10],
                  "fill": "dash"
                }
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "text",
                  "mode": "fixed"
                }
              },
              {
                "id": "custom.lineWidth",
                "value": 1
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 15,
        "w": 24,
        "x": 0,
        "y": 59
      },
      "id": 1,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\")\n  |> filter(fn: (r) => r[\"_field\"] == \"spl\")\n  |> group(columns: [\"frequency_weighting\"])\n  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)\n  |> drop(columns: [\"_start\", \"_stop\", \"_measurement\"])\n  |> yield(name: \"spl_result\")\n",
          "refId": "Live Raw"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\")\n  |> filter(fn: (r) => r[\"_field\"] == \"spl\")\n\n  // üîë On conserve le pond√©rateur fr√©quentiel\n  |> group(columns: [\"frequency_weighting\"])\n\n  // 1. Bruit de fond (quantile 10%)\n  |> aggregateWindow(\n      every: v.windowPeriod,\n      fn: (column, tables=<-) => tables |> quantile(q: 0.10),\n      createEmpty: false\n  )\n\n  // 2. √ânergie lin√©aire\n  |> map(fn: (r) => ({ r with _value: math.pow(x: 10.0, y: r._value / 10.0) }))\n\n  // 3. Moyenne 1 minute\n  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)\n\n  // 4. Retour en dB + renommage\n  |> map(fn: (r) => ({\n      r with\n      _value: 10.0 * math.log10(x: r._value),\n      _field: \"Niveau de Pression Sonore L90 (\" + r.frequency_weighting + \")\"\n  }))\n  |> drop(columns: [\"_start\", \"_stop\", \"_measurement\"])\n  |> yield(name: \"spl_result\")\n",
          "refId": "Live L90"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> filter(fn: (r) => exists r._value)\n  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)\n\n  // 3. Calcul des limites horaires et du d√©passement\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      \n      // Seuils r√©glementaires (50 / 45 / 40 dB)\n      limite = if h >= 7 and h < 19 then 50.0 \n               else if h == 6 or (h >= 19 and h < 22) then 45.0 \n               else 40.0\n      \n      // Calcul du d√©passement\n      diff = if r._value > limite then r._value - limite else 0.0\n      \n      return {\n          _time: r._time,\n          _value: diff,\n          _field: \"D√©passement (dB)\",\n      }\n  })\n  \n  // 4. Envoi des donn√©es vers Grafana\n  |> yield(name: \"depassement_acoustique\")",
          "refId": "B"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"date\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"dt8852\" and r._field == \"spl\")\n  |> aggregateWindow(every: v.windowPeriod, fn: first)\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      return {\n          _time: r._time,\n          _limit: if h >= 7 and h < 19 then 50.0 \n                  else if h == 6 or (h >= 19 and h < 22) then 45.0 \n                  else 40.0\n      }\n  })",
          "refId": "A"
        }
      ],
      "title": "Vue en Temps R√©el",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Encode la conformit√© minute par minute. Les donn√©es SPL sont agr√©g√©es par minute, puis compar√©es √† la limite horaire (40/45/50 dB) calcul√©e sur la m√™me horodatation. Le r√©sultat est un statut binaire: conforme ou infraction\n",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "axisPlacement": "auto",
            "fillOpacity": 70,
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineWidth": 0,
            "spanNulls": false
          },
          "mappings": [
            {
              "options": {
                "0": {
                  "color": "dark-red",
                  "index": 0,
                  "text": "Infraction"
                },
                "1": {
                  "color": "dark-green",
                  "index": 1,
                  "text": "Conforme"
                }
              },
              "type": "value"
            }
          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 5,
        "w": 24,
        "x": 0,
        "y": 74
      },
      "id": 8,
      "options": {
        "alignValue": "left",
        "legend": {
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "mergeValues": true,
        "rowHeight": 0.9,
        "showValue": "auto",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  // Fen√™trage pour all√©ger le rendu (ex: toutes les 1m)\n  |> aggregateWindow(every: 1m, fn: max, createEmpty: false)\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      limit = if h >= 7 and h < 19 then 50.0 \n              else if h == 6 or (h >= 19 and h < 22) then 45.0 \n              else 40.0\n      \n      return { _time: r._time, _field: \"Statut\", _value: if r._value > limit then \"0\" else \"1\" }\n  })",
          "refId": "A"
        }
      ],
      "title": "Historique des Infractions",
      "type": "state-timeline"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Suivi en temps r√©el du d√©passement des limites acoustiques r√©glementaires (50/45/40 dB) avec d√©tection automatique des p√©riodes Jour, Aube, Soir et Nuit.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineStyle": {
              "fill": "solid"
            },
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "seuil_legal"
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": false
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": 0
                    },
                    {
                      "color": "dark-orange",
                      "value": 45
                    },
                    {
                      "color": "dark-red",
                      "value": 50
                    }
                  ]
                }
              },
              {
                "id": "color",
                "value": {
                  "mode": "thresholds",
                  "seriesBy": "last"
                }
              },
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [10, 10],
                  "fill": "dash"
                }
              },
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              },
              {
                "id": "displayName",
                "value": "Seuil Legal"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "niveau_reel"
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              },
              {
                "id": "displayName",
                "value": "Niveau reel"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "_value"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "D√©passement (dB)"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 24,
        "x": 0,
        "y": 79
      },
      "id": 23,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"math\"\nimport \"timezone\"\nimport \"date\"\n\n// 1. Configuration de l'environnement\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> filter(fn: (r) => exists r._value)\n  \n  // 2. Agr√©gation temporelle (√©vite l'erreur de trop grand nombre de points)\n  //|> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)\n  |> aggregateWindow(every: v.windowPeriod, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n  // 3. Calcul des limites horaires et du d√©passement\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      \n      // Seuils r√©glementaires (50 / 45 / 40 dB)\n      limite = if h >= 7 and h < 19 then 50.0 \n               else if h == 6 or (h >= 19 and h < 22) then 45.0 \n               else 40.0\n      \n      // Calcul du d√©passement\n      diff = if r._value > limite then r._value - limite else 0.0\n      \n      return {\n          _time: r._time,\n          _value: diff,\n          _field: \"D√©passement (dB)\",\n          niveau_reel: r._value,\n          seuil_legal: limite,\n          statut: if diff > 0.0 then \"üî¥ INFRACTION\" else \"üü¢ CONFORME\"\n      }\n  })\n  \n  // 4. Envoi des donn√©es vers Grafana\n  |> yield(name: \"depassement_acoustique\")",
          "refId": "A"
        }
      ],
      "title": "Analyse des √âmergences : Conformit√© aux Seuils L√©gaux",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Vue chronologique classifiant l'intensit√© des d√©passements acoustiques par rapport aux limites r√©glementaires (50/45/40 dB) par paliers de s√©v√©rit√©.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "axisPlacement": "auto",
            "fillOpacity": 80,
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineWidth": 0,
            "spanNulls": false
          },
          "fieldMinMax": false,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              },
              {
                "color": "dark-yellow",
                "value": 5
              },
              {
                "color": "dark-orange",
                "value": 10
              },
              {
                "color": "dark-red",
                "value": 15
              },
              {
                "color": "dark-purple",
                "value": 20
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 24,
        "x": 0,
        "y": 87
      },
      "id": 24,
      "options": {
        "alignValue": "left",
        "legend": {
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "mergeValues": true,
        "rowHeight": 1,
        "showValue": "never",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"math\"\nimport \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> aggregateWindow(every: v.windowPeriod, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      limite = if h >= 7 and h < 19 then 50.0 \n               else if h == 6 or (h >= 19 and h < 22) then 45.0 \n               else 40.0\n      \n      depassement = if r._value > limite then r._value - limite else 0.0\n      \n      return {\n          _time: r._time,\n          _value: depassement,\n          _field: \"D√©passement (dB)\",\n      }\n  })\n",
          "refId": "A"
        }
      ],
      "title": "S√©v√©rit√© des Nuisances Acoustiques",
      "type": "state-timeline"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 95
      },
      "id": 14,
      "panels": [],
      "title": "Profil Sonore et Rythmes Horaires",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 6,
        "w": 24,
        "x": 0,
        "y": 96
      },
      "id": 15,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Cette section d√©crit la **signature acoustique** du lieu sur la dur√©e, en distinguant le **bruit de fond** des √©pisodes plus marqu√©s.\n\n### Fr√©quence sonore\n\nLes mesures sont d‚Äôabord regroup√©es pour r√©duire le volume de donn√©es, puis class√©es par **paliers de 3 dB**. Ce choix facilite l‚Äôinterpr√©tation, car un pas de 3 dB correspond √† une variation √©nerg√©tique significative.  \nLes s√©ries sont ensuite s√©par√©es par p√©riodes (jour, soir√©e, aube, nuit) afin de comparer les distributions selon l‚Äôheure.\n\n### Histogramme de Pression Sonore\n\nLe second graphique calcule la **m√©diane** du niveau sonore sur des fen√™tres de **15 minutes**. La m√©diane r√©duit l‚Äôinfluence des bruits brefs et met en √©vidence l‚Äôambiance sonore typique et les rythmes r√©guliers (jour/nuit, pics d‚Äôactivit√©).\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Histogramme des niveaux sonores class√©s par paliers de 3 dB et s√©par√©s par p√©riodes horaires (jour / aube / soir√©e / nuit). Les donn√©es sont pr√©alablement regroup√©es pour limiter le volume affich√©. Utile pour identifier le niveau dominant (bruit de fond) et la dispersion des niveaux.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "fillOpacity": 80,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "stacking": {
              "group": "A",
              "mode": "none"
            }
          },
          "mappings": [],
          "max": 120,
          "min": 30,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Jour (Limite 50dB)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-blue",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Soir√©e (Limite 45dB)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Aube / Matin√©e (Limite 45dB)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Nuit (Limite 40dB)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#000064",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 15,
        "w": 24,
        "x": 0,
        "y": 102
      },
      "id": 3,
      "options": {
        "combine": false,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  // 1. Keep data volume safe (10s resolution)\n  |> aggregateWindow(every: 10s, fn: last, createEmpty: false)\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      \n      // 2. Define the four distinct periods\n      period = if h >= 7 and h < 19 then \"Jour (Limite 50dB)\"\n               else if h >= 19 and h < 22 then \"Soir√©e (Limite 45dB)\"\n               else if h >= 6 and h < 7 then \"Aube / Matin√©e (Limite 45dB)\"\n               else \"Nuit (Limite 40dB)\"\n      \n      return { r with \n          // 3. Bucket by 3dB for acoustic significance\n          _value: math.floor(x: r._value / 3.0) * 3.0,\n          // 4. Use the period name as the field for the histogram series\n          _field: period\n      }\n  })\n  |> keep(columns: [\"_time\", \"_value\", \"_field\"])",
          "refId": "A"
        }
      ],
      "title": "Fr√©quence Sonore",
      "type": "histogram"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Affiche la m√©diane du niveau sonore par fen√™tres de 15 minutes. Ce choix met en avant le niveau typique en limitant l‚Äôimpact des √©v√©nements brefs. Id√©al pour visualiser les cycles d‚Äôactivit√© et les p√©riodes de calme relatif.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "fillOpacity": 80,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 2,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "fieldMinMax": true,
          "mappings": [],
          "max": 80,
          "min": 40,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 14,
        "w": 24,
        "x": 0,
        "y": 117
      },
      "id": 4,
      "options": {
        "barRadius": 0,
        "barWidth": 0.6,
        "colorByField": "Time",
        "fullHighlight": false,
        "groupWidth": 1,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": false
        },
        "orientation": "auto",
        "showValue": "auto",
        "stacking": "none",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        },
        "xField": "Time",
        "xTickLabelRotation": 0,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\")\n  |> filter(fn: (r) => r[\"_field\"] == \"spl\")\n  |> keep(columns: [\"_time\", \"_value\", \"_field\", \"frequency_weighting\"])\n  //|> aggregateWindow(every: 15m, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n  |> aggregateWindow(every: 15m, fn: mean, createEmpty: false)\n  |> map(fn: (r) => ({ \n      r with \n      _value: math.round(x: r._value),\n      _field: \"Niveau de Pression Sonore\" \n  }))  \n  |> yield(name: \"hourly_peaks\")",
          "refId": "A"
        }
      ],
      "title": "Histogramme de Pression Sonore",
      "type": "barchart"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 131
      },
      "id": 12,
      "panels": [],
      "title": "Analyse des √âv√©nements et Nuisances",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 10,
        "w": 24,
        "x": 0,
        "y": 132
      },
      "id": 13,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Ce module met en √©vidence les √©v√©nements les plus significatifs, en distinguant les **pics** et les **nuisances durables**.\n\n### Volume maximum enregistr√©\n\nLa jauge indique le **niveau sonore le plus √©lev√©** observ√© sur la p√©riode affich√©e. Elle sert √† rep√©rer un choc acoustique potentiel, sans tenir compte de sa dur√©e.\n\n### Nuisances persistantes (> 60 dB)\n\nCe panneau recherche des s√©quences o√π le niveau reste **au-dessus de 60 dB** de mani√®re continue pendant suffisamment longtemps pour √™tre qualifi√© de nuisance.\n\nTraitement appliqu√© :\n1. Regroupement des mesures sur des tranches courtes pour stabiliser l‚Äôanalyse.\n2. Lissage r√©alis√© sur une grandeur √©nerg√©tique (et non directement en dB) afin d‚Äô√©viter que de petites oscillations autour du seuil ne fragmentent artificiellement une s√©quence.\n3. Calcul de la dur√©e pendant laquelle le niveau reste au-dessus du seuil, puis filtrage pour ne conserver que les √©pisodes d‚Äôau moins **2 minutes**.\n\nLe graphique affiche simultan√©ment l‚Äôintensit√© (en dB) et la dur√©e de l‚Äô√©pisode (en secondes), afin de relier niveau et persistance.\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Analyse approfondie des √©v√©nements sonores significatifs. Ce panneau isole et visualise les p√©riodes o√π le niveau sonore a d√©pass√© 60 dB de mani√®re continue pendant plus de 2 minutes (120s), permettant d'identifier les nuisances longues et persistantes par rapport aux bruits transitoires.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 6,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": true,
            "spanNulls": true,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "dtdurations"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Dur√©e de la nuisance (> 60dB)"
            },
            "properties": [
              {
                "id": "custom.axisPlacement",
                "value": "right"
              },
              {
                "id": "unit",
                "value": "dtdurations"
              },
              {
                "id": "custom.lineInterpolation",
                "value": "stepBefore"
              },
              {
                "id": "custom.fillOpacity",
                "value": 50
              },
              {
                "id": "custom.scaleDistribution",
                "value": {
                  "log": 2,
                  "type": "log"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Intensit√©"
            },
            "properties": [
              {
                "id": "unit",
                "value": "dB"
              },
              {
                "id": "custom.lineInterpolation",
                "value": "smooth"
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "#fffd0038",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byFrameRefID",
              "options": "B"
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              },
              {
                "id": "unit",
                "value": "dB"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "_value D√©passement (dB)"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "D√©passement (dB)"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "seuil_legal"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Seuil Legal"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 11,
        "w": 24,
        "x": 0,
        "y": 142
      },
      "id": 9,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"math\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  \n  // 1. Fen√™trage de base\n  |> aggregateWindow(every: 10s, fn: max, createEmpty: false)\n\n  // --- D√âBUT DU LISSAGE √âNERG√âTIQUE ---\n  // 2. Conversion des dB en √©chelle lin√©aire (√©nergie)\n  |> map(fn: (r) => ({ r with _value: math.pow(x: 10.0, y: r._value / 10.0) }))\n  \n  // 3. Moyenne glissante sur 30 secondes (6 points de 5s)\n  |> exponentialMovingAverage(n: 12)\n  \n  // 4. Retour en d√©cibels (√©chelle logarithmique)\n  |> map(fn: (r) => ({ r with _value: 10.0 * math.log10(x: r._value) }))\n  // --- FIN DU LISSAGE √âNERG√âTIQUE ---\n\n  // 5. Calcul de la dur√©e cons√©cutive au dessus de 55.0 dB\n  // On le fait sur la valeur liss√©e pour √©viter les micro-coupures du compteur\n  |> stateDuration(fn: (r) => r._value > 60.0, column: \"noisy_seconds\", unit: 1s)\n\n  // 6. Nettoyage : transformer les -1 (sous le seuil) en 0\n  |> map(fn: (r) => ({\n      r with \n      noisy_seconds: if r.noisy_seconds == -1 then 0 else r.noisy_seconds\n  }))\n\n  // 7. FILTRE : On ne garde que les s√©quences qui durent plus de 120s (2 minutes)\n  |> filter(fn: (r) => r.noisy_seconds >= 120)\n\n  // 8. Formatage final pour un affichage propre dans Grafana\n  |> map(fn: (r) => ({\n      _time: r._time,\n      \"Intensit√©\": math.round(x: r._value * 10.0) / 10.0, // Arrondi 1 d√©cimale\n      \"Dur√©e de la nuisance (> 60dB)\": float(v: r.noisy_seconds)\n  }))\n  |> yield(name: \"nuisances_analyse\")",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> filter(fn: (r) => exists r._value)\n  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      \n      limite = if h >= 7 and h < 19 then 50.0 \n               else if h == 6 or (h >= 19 and h < 22) then 45.0 \n               else 40.0\n      \n      diff = if r._value > limite then r._value - limite else 0.0\n      \n      return {\n          _time: r._time,\n          _value: diff,\n          _field: \"D√©passement (dB)\",\n          seuil_legal: limite,\n      }\n  })\n  \n  |> yield(name: \"depassement_acoustique\")",
          "refId": "B"
        }
      ],
      "title": "Nuisances persistantes (> 60 dB)",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Indique l'intensit√© maximale (cr√™te) enregistr√©e sur la p√©riode s√©lectionn√©e. Les codes couleurs (Vert √† Rouge fonc√©) signalent imm√©diatement les niveaux critiques (>60dB, >75dB) n√©cessitant une attention particuli√®re.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "displayName": "Sound Pressure Level (${__field.labels.frequency_weighting})",
          "fieldMinMax": false,
          "mappings": [],
          "max": 100,
          "min": 30,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "dark-green",
                "value": 30
              },
              {
                "color": "dark-yellow",
                "value": 45
              },
              {
                "color": "red",
                "value": 60
              },
              {
                "color": "dark-red",
                "value": 75
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 10,
        "w": 24,
        "x": 0,
        "y": 153
      },
      "id": 2,
      "options": {
        "minVizHeight": 75,
        "minVizWidth": 75,
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": true,
        "showThresholdMarkers": true,
        "sizing": "auto"
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\")\n  |> filter(fn: (r) => r[\"_field\"] == \"spl\")\n  |> keep(columns: [\"_time\", \"_value\", \"_field\", \"frequency_weighting\"])\n  |> max()",
          "refId": "A"
        }
      ],
      "title": "Volume Maximum Enregistr√©",
      "type": "gauge"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 163
      },
      "id": 20,
      "panels": [],
      "title": "Indicateurs Experts et Contexte",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 9,
        "w": 24,
        "x": 0,
        "y": 164
      },
      "id": 21,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Cette section applique des indicateurs courants de mesure acoustique pour caract√©riser l‚Äôambiance sonore au-del√† d‚Äôune moyenne simple.\n\n### Indicateurs L10 / L50 / L90 (sur 60 minutes)\n\nSur chaque fen√™tre d‚Äôune heure, trois indicateurs sont calcul√©s :\n- **L10** : Le niveau sonore d√©pass√© pendant 10 % du temps. Il repr√©sente les √©v√©nements sonores les plus forts (passages de voitures, cris, travaux).\n- **L50** : Le niveau d√©pass√© pendant 50 % du temps. C'est l'indicateur de la \"tendance\" sonore globale.\n- **L90** : Le niveau d√©pass√© pendant 90 % du temps. Il repr√©sente le niveau sonore calme, quand il n'y a pas d'√©v√©nement particulier. C'est le \"bruit r√©siduel\" de la ville.\n\nCette lecture permet de s√©parer objectivement un bruit ambiant stable de pics plus rares mais plus forts.\n\n### Localisation du Capteur\n\nLa carte situe le capteur dans l‚Äôenvironnement. Ce rep√®re est utile pour interpr√©ter les variations (distance aux sources, obstacles, r√©flexions sur les fa√ßades).\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "R√©partition statistique du bruit sur l'ensemble de la p√©riode. Trois indicateurs bas√©s sur la distribution des niveaux sonores: \n\n- L10 (Niveau de Pointe) : Niveau d√©pass√© 10% du temps. Repr√©sente les √©v√©nements bruyants (trafic, aboiements, travaux).\n- L50 (Niveau M√©dian): Le niveau sonore moyen ressenti la majorit√© du temps.\n- L90 (Bruit de Fond): Niveau d√©pass√© 90% du temps. Repr√©sente le calme r√©siduel de l'environnement (ce qu'il reste quand tout s'arr√™te).\n\nCes valeurs permettent de distinguer les pics du niveau ambiant r√©siduel.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "dark-red",
            "mode": "fixed"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byRegexp",
              "options": "/.*L10.*/"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L10 (Pics)"
              }
            ]
          },
          {
            "matcher": {
              "id": "byRegexp",
              "options": "/.*L50.*/"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L50 (M√©diane)"
              }
            ]
          },
          {
            "matcher": {
              "id": "byRegexp",
              "options": "/.*L90.*/"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L90 (Bruit de fond)"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 11,
        "w": 24,
        "x": 0,
        "y": 173
      },
      "id": 10,
      "options": {
        "displayMode": "lcd",
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": false
        },
        "maxVizHeight": 300,
        "minVizHeight": 16,
        "minVizWidth": 8,
        "namePlacement": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [],
          "fields": "",
          "values": false
        },
        "showUnfilled": true,
        "sizing": "auto",
        "valueMode": "color"
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"math\"\nimport \"timezone\"\noption location = timezone.location(name: \"Europe/Brussels\")\n\ndata = from(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\")\n  |> filter(fn: (r) => r[\"_field\"] == \"spl\")\n  |> group() \n\nl10 = data\n  |> quantile(q: 0.90)\n  |> map(fn: (r) => ({ _field: \"L10 (Pics)\", _value: math.round(x: r._value) }))\n\nl50 = data\n  |> quantile(q: 0.50)\n  |> map(fn: (r) => ({ _field: \"L50 (M√©diane)\", _value: math.round(x: r._value) }))\n\nl90 = data\n  |> quantile(q: 0.10)\n  |> map(fn: (r) => ({ _field: \"L90 (Bruit de fond)\", _value: math.round(x: r._value) }))\n\nunion(tables: [l10, l50, l90])\n  |> group(columns: [\"_field\"])\n  |> yield(name: \"acoustic_stats\")",
          "refId": "A"
        }
      ],
      "title": "Signature Acoustique Globale (L10 / L50 / L90)",
      "type": "bargauge"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Calcul de la dynamique du bruit: Diff√©rence entre le niveau de pointe (L10) et le niveau de fond (L90).\n\n- Valeur √©lev√©e (> 15 dB) : Bruit fluctuant, trafic, √©v√©nements ponctuels.\n- Valeur faible (< 5 dB) : Bruit monotone et continu. C'est la signature typique d'une **Pompe √† Chaleur** ou d'une VMC.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "text",
            "mode": "fixed",
            "seriesBy": "last"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "opacity",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": true,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "dashed+area"
            }
          },
          "displayName": "Indice de Monotonie",
          "fieldMinMax": false,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              },
              {
                "color": "dark-orange",
                "value": 5
              },
              {
                "color": "dark-red",
                "value": 15
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byFrameRefID",
              "options": "B"
            },
            "properties": [
              {
                "id": "mappings",
                "value": [
                  {
                    "options": {
                      "from": 0,
                      "result": {
                        "color": "dark-green",
                        "index": 0,
                        "text": "Stable"
                      },
                      "to": 5
                    },
                    "type": "range"
                  },
                  {
                    "options": {
                      "from": 5,
                      "result": {
                        "color": "dark-orange",
                        "index": 1,
                        "text": "Fluctuant"
                      },
                      "to": 15
                    },
                    "type": "range"
                  },
                  {
                    "options": {
                      "from": 15,
                      "result": {
                        "color": "dark-red",
                        "index": 2,
                        "text": "Hautement variable"
                      },
                      "to": 100
                    },
                    "type": "range"
                  }
                ]
              },
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 9,
        "w": 24,
        "x": 0,
        "y": 184
      },
      "id": 22,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\n// Configuration de la zone horaire\noption location = timezone.location(name: \"Europe/Brussels\")\n\n// 1. R√©cup√©ration et nettoyage des donn√©es\ndata = from(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> filter(fn: (r) => exists r._value) // On ignore les points vides\n\n// 2. Calcul du L10 (Pics sonores)\nl10 = data \n  |> aggregateWindow(every: 30m, fn: (column, tables=<-) => tables |> quantile(q: 0.90), createEmpty: false)\n\n// 3. Calcul du L90 (Bruit de fond)\nl90 = data \n  |> aggregateWindow(every: 30m, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n\njoin(tables: {l10: l10, l90: l90}, on: [\"_time\"])\n  |> map(fn: (r) => {\n      // Calcul de la diff√©rence brute\n      raw_diff = r._value_l10 - r._value_l90\n      \n      // Correction : Si n√©gatif (erreur de calcul), on ram√®ne √† 0\n      val = if raw_diff < 0.0 then 0.0 else raw_diff\n      \n      return {\n          _time: r._time,\n          _value: val,\n          _field: \"Climat Sonore (L10-L90)\"\n      }\n  })",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\n// Configuration de la zone horaire\noption location = timezone.location(name: \"Europe/Brussels\")\n\n// 1. R√©cup√©ration et nettoyage des donn√©es\ndata = from(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> filter(fn: (r) => exists r._value) // On ignore les points vides\n\n// 2. Calcul du L10 (Pics sonores)\nl10 = data \n  |> aggregateWindow(every: 30m, fn: (column, tables=<-) => tables |> quantile(q: 0.90), createEmpty: false)\n\n// 3. Calcul du L90 (Bruit de fond)\nl90 = data \n  |> aggregateWindow(every: 30m, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n\njoin(tables: {l10: l10, l90: l90}, on: [\"_time\"])\n  |> map(fn: (r) => {\n      // Calcul de la diff√©rence brute\n      raw_diff = math.round(x: r._value_l10 - r._value_l90)\n      \n      // Correction : Si n√©gatif (erreur de calcul), on ram√®ne √† 0\n      val = if raw_diff < 0.0 then 0.0 else raw_diff\n      \n      return {\n          _time: r._time,\n          _value: val,\n          _field: \"Variability\"\n      }\n  })",
          "refId": "B"
        }
      ],
      "title": "Signature du Bruit: Dynamique & Monotonie",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Affiche la position du capteur √† partir de coordonn√©es d√©finies dans le tableau de bord (point fixe). Sert √† interpr√©ter les mesures en fonction de l‚Äôenvironnement imm√©diat (obstacles, voisinage, g√©om√©trie des lieux).",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 11,
        "w": 24,
        "x": 0,
        "y": 193
      },
      "id": 5,
      "options": {
        "basemap": {
          "config": {},
          "name": "Layer 0",
          "noRepeat": false,
          "type": "default"
        },
        "controls": {
          "mouseWheelZoom": true,
          "showAttribution": true,
          "showDebug": false,
          "showMeasure": false,
          "showScale": false,
          "showZoom": true
        },
        "layers": [
          {
            "config": {
              "blur": 50,
              "radius": 50,
              "weight": {
                "fixed": 1,
                "max": 1,
                "min": 0
              }
            },
            "filterData": {
              "id": "byRefId",
              "options": "A"
            },
            "layer-tooltip": true,
            "location": {
              "mode": "auto"
            },
            "name": "Layer 1",
            "opacity": 0.5,
            "tooltip": true,
            "type": "heatmap"
          }
        ],
        "tooltip": {
          "mode": "details"
        },
        "view": {
          "allLayers": true,
          "id": "coords",
          "lat": 50.599922,
          "lon": 4.32828,
          "noRepeat": false,
          "zoom": 17.78
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"array\"\n\narray.from(rows: [{\n    lat: 50.599724, \n    lon: 4.328188, \n    location_name: \"Ext√©rieur, Jardin\",\n    sensor_type: \"Trotec SL400\"\n}])",
          "refId": "A"
        }
      ],
      "title": "Localisation du Capteur",
      "type": "geomap"
    }
  ],
  "preload": false,
  "refresh": "auto",
  "schemaVersion": 42,
  "tags": [],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-3h",
    "to": "now"
  },
  "timepicker": {
    "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "4h", "1d", "2d", "7d"]
  },
  "timezone": "browser",
  "title": "Noise Station",
  "uid": "adx4w44",
  "version": 1,
  "weekStart": "monday"
}
