{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": 54,
  "links": [],
  "liveNow": true,
  "panels": [
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 11,
      "panels": [],
      "title": "A propos de Noise Station et réglementation en Région Wallonne",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 30,
        "w": 12,
        "x": 0,
        "y": 1
      },
      "id": 6,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "# Noise Station\n\n### Un système de monitoring acoustique intelligent\n\nLa **Noise Station** est une solution de surveillance environnementale de haute précision conçue pour capturer, analyser et visualiser les niveaux sonores d'un espace en temps réel. Elle transforme des données acoustiques brutes en indicateurs visuels pour suivre l'évolution du bruit, détecter les pics et comprendre le profil sonore d'un lieu sur 24 heures.\n\n# Comment ça fonctionne ?\n\n### 1. La Capture (Le Matériel)\n\nLe système s'appuie sur un microphone professionnel de type **Trotec SL400** (équivalent du **CEM DT-8852**). Ce sonomètre de Classe 2 offre des fonctionnalités indispensables :\n-   **Double Pondération:** Supporte les courbes **dB(A)** (perception humaine) et **dB(C)** (basses fréquences).\n-   **Plage Dynamique:** Mesure précise de 30 à 130 dB (précision : 1,4 dB, résolution : 0,1 dB)\n-   **Modes Temporels:** Analyse en mode \"Fast\" (réactivité immédiate) ou \"Slow\" (stabilité).\n-   **Signaux numériques:** Uniquement les données numériques (et pas analogique) sont transmises. \n-   **Certification:** Livré avec certificat de calibration, conforme à IEC61672-1 Class 2\n\n### 2. Le Cœur du Système (L'Intelligence)\n\nLes données sont traitées par une unité de calcul (**Raspberry Pi**) et stockées dans une base de données temporelle (**InfluxDB**):\n*   **Nettoyage :** Filtrage des métadonnées pour une lecture fluide.\n*   **Agrégation :** Calcul de statistiques avancées (L10, L50, L90) en temps réel.\n\n### 3. La Visualisation (Le Dashboard)\n\nLe dashboard utilise plusieurs méthodes d'analyse pour une vue complète :\n\n*   **Vue Temps Réel (Conformité) :** Vérifie si le **niveau médian (L50)** respecte les seuils légaux (40/45/50 dB). Il colore le graphe en rouge si un dépassement persiste plus de **2 minutes**, ce qui permet de distinguer une nuisance réelle (ex: pompe à chaleur) d'un bruit passager (ex: avion).\n*   **Analyse des Émergences (Bruit de Fond) :** Un graphique spécifique qui utilise le **L90** pour isoler le bruit de fond constant et prouver qu'il dépasse à lui seul les normes, même sans pic sonore.\n*   **Pic de Volume (Volume Maximum Enregistré) :** Une jauge dynamique qui surveille le volume maximal atteint durant la **période affichée**. Elle utilise des seuils colorés (du vert au rouge foncé dès 80 dB) pour alerter sur les événements sonores récents.\n*   **Profil Statistique (Fréquence Sonore) :** Un histogramme qui regroupe les mesures des dernières 24 heures par paliers de décibels (arrondis à l'unité). Il permet de voir en un coup d'œil quel niveau de bruit est le plus fréquent dans l'environnement.\n*   **Distribution Horaire :** Un graphique en barres affichant la **moyenne sonore pour chaque heure** de la journée. Idéal pour identifier les cycles de pollution sonore (journée de travail vs nuit).\n*   **Géolocalisation :** Une carte intégrée affichant l'emplacement précis du capteur.\n\n# Pourquoi utiliser Noise Station ?\n\nPasser du ressenti subjectif (\"c'est bruyant\") à une mesure objective (\"la moyenne est de 65 dB avec des pics à 85 dB\"). Que ce soit pour le confort au travail, la surveillance de voisinage ou l'analyse environnementale, la **Noise Station** fournit une preuve scientifique et visuelle de la réalité acoustique de votre environnement.",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 11,
        "w": 12,
        "x": 12,
        "y": 1
      },
      "id": 7,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "En Région Wallonne (https://www.ejustice.just.fgov.be/eli/arrete/2002/07/04/2002027815/justel), le cadre légal est clair et rigoureux. Depuis l’arrêté du Gouvernement wallon du 4 juillet 2022, des limites de bruit spécifiques s’appliquent aux PAC selon les différentes périodes de la journée :\n\n- En journée (7h-19h): le bruit ne doit pas dépasser 50 dB.\n- En transition (6h-7h, 19h-22h): la limite est réduite à 45 dB.\n- La nuit (22h-6h): le niveau sonore doit impérativement rester sous 40 dB.\n\nLe bruit se propage en cercle autour d'une unité extérieure (PAC). \nIl est donc crucial de faire attention aux surfaces environnantes, comme des murs ou d’autres bâtiments, qui peuvent réfléchir le son et provoquer un effet d’écho. Pour limiter cette résonance, maintenez au moins un mètre d’espace autour de la pompe, en particulier par rapport aux fenêtres, aux portes et aux chemins. Si l’unité est placée contre un mur, veillez à respecter une distance minimale de 30 centimètres — l’idéal étant de 50 centimètres — pour garantir une circulation sonore optimale. Il est également important de prendre en compte la distance entre la face avant de la pompe à chaleur et les trottoirs, qui doit être d’au moins 3 mètres et d’au moins 6 mètres pour les plantes.\n\nSource: https://www.bobex.be/fr-be/pompe-a-chaleur/installation/distance-voisin/\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "Réglementation en Région Wallonne",
      "type": "text"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 19,
        "w": 12,
        "x": 12,
        "y": 12
      },
      "id": 25,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Les niveaux sonores présentés sont exprimés en décibels selon des pondérations fréquentielles normalisées.\n\nLa pondération dB(A) est définie afin de reproduire la sensibilité moyenne de l’oreille humaine et constitue la référence réglementaire utilisée par les autorités compétentes pour l’évaluation du respect des seuils légaux de bruit. Elle atténue significativement les basses fréquences, ce qui peut conduire à une sous-évaluation de certaines nuisances d’origine mécanique.\n\nLa pondération dB(C), plus linéaire sur l’ensemble du spectre audible, permet de mesurer l’énergie acoustique globale, y compris les basses fréquences. Elle est particulièrement pertinente pour l’analyse de nuisances sonores persistantes à dominante grave, telles que celles générées par des équipements techniques fixes, notamment les pompes à chaleur.\n\nL’utilisation conjointe et complémentaire de ces deux pondérations permet ainsi de distinguer la conformité réglementaire d’une part, et la réalité de la gêne acoustique subie d’autre part.\n\n---\n\nLa pondération dB(A) permet d’apprécier le respect des seuils réglementaires applicables, tandis que la pondération dB(C) constitue un indicateur pertinent de la nuisance acoustique réelle lorsqu’elle est dominée par des basses fréquences, notamment dans le cas d’équipements techniques tels qu’une pompe à chaleur.\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "Pondérations acoustiques dB(A) et dB(C)",
      "type": "text"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 31
      },
      "id": 16,
      "panels": [],
      "title": "Surveillance en Temps Réel et Conformité",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 13,
        "w": 24,
        "x": 0,
        "y": 32
      },
      "id": 17,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Cette section met en regard le **niveau sonore médian (L50)** et les **seuils réglementaires applicables en Région Wallonne**.\n\n### Vue en Temps Réel\n\nLe panneau *Vue en Temps Réel* est un outil de **contrôle de conformité** direct. Il part des mesures SPL brutes et applique la logique suivante :\n\n1. **Calcul de la Médiane Lissée (L50)** : Le niveau sonore médian est calculé et lissé. C'est l'indicateur de référence pour évaluer le niveau typique sans l'influence excessive des pics brefs.\n2. **Comparaison Légale** : Chaque point est comparé à la limite autorisée selon l'heure (50dB jour / 45dB transition / 40dB nuit).\n3. **Détection d'Infraction** : Si le niveau dépasse la limite, le système vérifie la **durée** du dépassement.\n    *   **OK (Vert)** : Le niveau est conforme.\n    *   **En attente (Rouge)** : Le niveau dépasse le seuil, mais depuis moins de 2 minutes (tolérance technique).\n    *   **NOK (Rouge)** : Le dépassement est confirmé car il dure depuis plus de **2 minutes**. C'est une infraction potentielle.\n\nCette méthode permet de filtrer les pics brefs pour ne signaler que les dépassements significatifs.\n\n### Historique des Infractions\n\nCe panneau binaire enregistre les moments où le bruit a été jugé comme une nuisance (Infraction confirmée > 2 min). C'est l'historique officiel des non-conformités.\n\n### Analyse des Émergences (Bruit de Fond)\n\nA l'inverse, le graphique *Analyse des Émergences* (plus bas) utilise le **L90 (Bruit de Fond)**. Il sert à prouver la présence d'une machine (ex: Pompe à chaleur) en ignorant les bruits de passage. Si ce graphe montre un dépassement, cela prouve que le \"calme\" du quartier est lui-même pollué.",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Affiche le SPL reconstruit sur des fenêtres de 30s à partir des mesures: conversion dB→énergie, agrégation en énergie, puis reconversion en dB. La courbe est comparée à une limite réglementaire dynamique (40/45/50 dB) calculée à partir de l’heure locale.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "green",
            "mode": "fixed",
            "seriesBy": "last"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineStyle": {
              "fill": "solid"
            },
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "displayName": "Sound Pressure Level (${__field.labels.frequency_weighting})",
          "fieldMinMax": false,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "nok"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-red",
                  "mode": "fixed"
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 20
              }
            ]
          },
          {
            "matcher": {
              "id": "byFrameRefID",
              "options": "Seuil Legal"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "text",
                  "mode": "fixed"
                }
              },
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [10, 10],
                  "fill": "dash"
                }
              },
              {
                "id": "displayName",
                "value": "Seuil Legal"
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "pending"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-red",
                  "mode": "fixed"
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 20
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "ok"
            },
            "properties": [
              {
                "id": "custom.fillOpacity",
                "value": 20
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "excess"
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              },
              {
                "id": "displayName",
                "value": "Depassement"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "text",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 15,
        "w": 24,
        "x": 0,
        "y": 45
      },
      "id": 1,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"date\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nminSeconds = 120\n\nbase =\n  from(bucket: \"default\")\n    |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n    |> filter(fn: (r) => r._measurement == \"dt8852\" and r._field == \"spl\")\n    |> keep(columns: [\"_time\", \"_value\", \"frequency_weighting\"])\n    |> aggregateWindow(\n        every: v.windowPeriod,\n        fn: (column, tables=<-) => tables |> quantile(q: 0.50),\n        createEmpty: false\n      )\n  |> exponentialMovingAverage(n: 30)\n  |> map(fn: (r) => {\n        h = date.hour(t: r._time)\n\n        limit =\n          if h >= 7 and h < 19 then 50.0\n          else if (h >= 6 and h < 7) or (h >= 19 and h < 22) then 45.0\n          else 40.0\n\n        exceed = r._value > limit\n        excess = if exceed then (r._value - limit) else 0.0\n\n        return { r with exceed: exceed, excess: excess }\n    })\n    |> group(columns: [\"frequency_weighting\"])\n\nclassified =\n  base\n    |> stateDuration(fn: (r) => r.exceed, column: \"exceed_seconds\", unit: 1s)\n    |> map(fn: (r) => ({\n        r with\n        status:\n          if not r.exceed then \"ok\"\n          else if r.exceed_seconds >= minSeconds then \"nok\"\n          else \"pending\"\n    }))\n\n// 1) Série statut (ok/pending/nok) sur _value (SPL)\nstatusSeries =\n  classified\n    |> map(fn: (r) => ({ r with _field: r.status }))\n    |> keep(columns: [\"_time\", \"frequency_weighting\", \"_field\", \"_value\"])\n\n// 2) Série limite\nlimitSeries =\n  classified\n    |> map(fn: (r) => ({ _time: r._time, frequency_weighting: r.frequency_weighting, _field: \"limit\", _value: r.limit }))\n\n// 3) Série dépassement (différence). On peut choisir : seulement quand NOK, ou dès exceed.\n// Ici: seulement quand NOK (dépassement \"confirmé\")\nexcessSeries =\n  classified\n    |> map(fn: (r) => ({\n        _time: r._time,\n        frequency_weighting: r.frequency_weighting,\n        _field: \"excess\",\n        _value: if r.status == \"nok\" then r.excess else 0.0\n    }))\n\nunion(tables: [statusSeries, limitSeries, excessSeries])\n  |> group(columns: [\"frequency_weighting\", \"_field\"])\n  |> pivot(rowKey: [\"_time\", \"frequency_weighting\"], columnKey: [\"_field\"], valueColumn: \"_value\")\n",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"date\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"dt8852\" and r._field == \"spl\")\n  |> aggregateWindow(every: v.windowPeriod, fn: first)\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      return {\n          _time: r._time,\n          _limit: if h >= 7 and h < 19 then 50.0 \n                  else if h == 6 or (h >= 19 and h < 22) then 45.0 \n                  else 40.0\n      }\n  })",
          "refId": "Seuil Legal"
        }
      ],
      "title": "Vue en Temps Réel",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Encode la conformité minute par minute. Les données SPL sont agrégées par minute, puis comparées à la limite horaire (40/45/50 dB) calculée sur la même horodatation. Le résultat est un statut binaire: conforme ou infraction\n",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisPlacement": "auto",
            "fillOpacity": 70,
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineWidth": 0,
            "spanNulls": false
          },
          "mappings": [
            {
              "options": {
                "0": {
                  "color": "dark-green",
                  "index": 0,
                  "text": "Conforme"
                },
                "1": {
                  "color": "dark-red",
                  "index": 1,
                  "text": "Infraction"
                }
              },
              "type": "value"
            }
          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Value"
            },
            "properties": [
              {
                "id": "custom.axisPlacement",
                "value": "hidden"
              },
              {
                "id": "displayName",
                "value": "Conformite"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 5,
        "w": 24,
        "x": 0,
        "y": 60
      },
      "id": 8,
      "options": {
        "alignValue": "left",
        "legend": {
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "mergeValues": true,
        "rowHeight": 0.9,
        "showValue": "never",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"dt8852\" and r._field == \"spl\")\n |> aggregateWindow(\n      every: 1m,\n      fn: (column, tables=<-) => tables |> quantile(q: 0.10, column: column),\n      createEmpty: false\n  )\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n\n      limit =\n        if h >= 7 and h < 19 then 50.0\n        else if (h >= 6 and h < 7) or (h >= 19 and h < 22) then 45.0\n        else 40.0\n\n      return {\n        _time: r._time,\n        _value: if r._value > limit then 1.0 else 0.0\n      }\n  })",
          "refId": "A"
        }
      ],
      "title": "Historique des Infractions",
      "type": "state-timeline"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Suivi en temps réel du dépassement des limites acoustiques réglementaires (50/45/40 dB) avec détection automatique des périodes Jour, Aube, Soir et Nuit.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "dark-red",
            "mode": "fixed"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 50,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineStyle": {
              "fill": "solid"
            },
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "seuil_legal"
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": false
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": 0
                    },
                    {
                      "color": "dark-orange",
                      "value": 45
                    },
                    {
                      "color": "dark-red",
                      "value": 50
                    }
                  ]
                }
              },
              {
                "id": "color",
                "value": {
                  "mode": "thresholds",
                  "seriesBy": "last"
                }
              },
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [10, 10],
                  "fill": "dash"
                }
              },
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              },
              {
                "id": "displayName",
                "value": "Seuil Legal"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "niveau_reel"
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              },
              {
                "id": "displayName",
                "value": "Niveau reel"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "_value"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Dépassement (dB)"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 24,
        "x": 0,
        "y": 65
      },
      "id": 23,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"math\"\nimport \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> filter(fn: (r) => exists r._value)\n  \n  //|> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)\n  |> aggregateWindow(every: v.windowPeriod, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n  // 3. Calcul des limites horaires et du dépassement\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      \n      // Seuils réglementaires (50 / 45 / 40 dB)\n      limite = if h >= 7 and h < 19 then 50.0 \n               else if (h >= 6 and h < 7) or (h >= 19 and h < 22) then 45.0 \n               else 40.0\n      \n      // Calcul du dépassement\n      diff = if r._value > limite then r._value - limite else 0.0\n      \n      return {\n          _time: r._time,\n          _value: diff,\n          _field: \"Dépassement (dB)\",\n          niveau_reel: r._value,\n          seuil_legal: limite\n      }\n  })\n  \n  // 4. Envoi des données vers Grafana\n  |> yield(name: \"depassement_acoustique\")",
          "refId": "A"
        }
      ],
      "title": "Analyse des Émergences : Conformité aux Seuils Légaux",
      "type": "timeseries"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 73
      },
      "id": 14,
      "panels": [],
      "title": "Profil Sonore et Rythmes Horaires",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 6,
        "w": 24,
        "x": 0,
        "y": 74
      },
      "id": 15,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Cette section décrit la **signature acoustique** du lieu sur la durée, en distinguant le **bruit de fond** des épisodes plus marqués.\n\n### Fréquence sonore\n\nLes mesures sont d’abord regroupées pour réduire le volume de données, puis classées par **paliers de 3 dB**. Ce choix facilite l’interprétation, car un pas de 3 dB correspond à une variation énergétique significative.  \nLes séries sont ensuite séparées par périodes (jour, soirée, aube, nuit) afin de comparer les distributions selon l’heure.\n\n### Évolution du Niveau Sonore Moyen\n\nLe second graphique calcule la **moyenne** du niveau sonore sur des fenêtres de **15 minutes**. La moyenne met en évidence l’énergie sonore cumulée et les rythmes réguliers (jour/nuit, pics d’activité).\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Histogramme des niveaux sonores classés par paliers de 3 dB et séparés par périodes horaires (jour / aube / soirée / nuit). Les données sont préalablement regroupées pour limiter le volume affiché. Utile pour identifier le niveau dominant (bruit de fond) et la dispersion des niveaux.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "fillOpacity": 80,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "stacking": {
              "group": "A",
              "mode": "none"
            }
          },
          "mappings": [],
          "max": 120,
          "min": 30,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Jour (Limite 50dB)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-blue",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Soirée (Limite 45dB)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Aube / Matinée (Limite 45dB)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Nuit (Limite 40dB)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#000064",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 15,
        "w": 24,
        "x": 0,
        "y": 80
      },
      "id": 3,
      "options": {
        "combine": false,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  // 1. Keep data volume safe (10s resolution)\n  |> aggregateWindow(every: 10s, fn: last, createEmpty: false)\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      \n      // 2. Define the four distinct periods\n      period = if h >= 7 and h < 19 then \"Jour (Limite 50dB)\"\n               else if h >= 19 and h < 22 then \"Soirée (Limite 45dB)\"\n               else if h >= 6 and h < 7 then \"Aube / Matinée (Limite 45dB)\"\n               else \"Nuit (Limite 40dB)\"\n      \n      return { r with \n          // 3. Bucket by 3dB for acoustic significance\n          _value: math.floor(x: r._value / 3.0) * 3.0,\n          // 4. Use the period name as the field for the histogram series\n          _field: period\n      }\n  })\n  |> keep(columns: [\"_time\", \"_value\", \"_field\"])",
          "refId": "A"
        }
      ],
      "title": "Distribution Statistique des Niveaux",
      "type": "histogram"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Affiche la médiane du niveau sonore par fenêtres de 15 minutes. Ce choix met en avant le niveau typique en limitant l’impact des événements brefs. Idéal pour visualiser les cycles d’activité et les périodes de calme relatif.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "fillOpacity": 80,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 2,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "fieldMinMax": true,
          "mappings": [],
          "max": 80,
          "min": 40,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 14,
        "w": 24,
        "x": 0,
        "y": 95
      },
      "id": 4,
      "options": {
        "barRadius": 0,
        "barWidth": 0.6,
        "colorByField": "Time",
        "fullHighlight": false,
        "groupWidth": 1,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": false
        },
        "orientation": "auto",
        "showValue": "auto",
        "stacking": "none",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        },
        "xField": "Time",
        "xTickLabelRotation": 0,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\")\n  |> filter(fn: (r) => r[\"_field\"] == \"spl\")\n  |> keep(columns: [\"_time\", \"_value\", \"_field\", \"frequency_weighting\"])\n  //|> aggregateWindow(every: 15m, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n  |> aggregateWindow(every: 15m, fn: mean, createEmpty: false)\n  |> map(fn: (r) => ({ \n      r with \n      _value: math.round(x: r._value),\n      _field: \"Niveau de Pression Sonore\" \n  }))  \n  |> yield(name: \"hourly_peaks\")",
          "refId": "A"
        }
      ],
      "title": "Évolution du Niveau Moyen (Leq 15m)",
      "type": "barchart"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 109
      },
      "id": 12,
      "panels": [],
      "title": "Analyse des Événements et Nuisances",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 24,
        "x": 0,
        "y": 110
      },
      "id": 13,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Ce module met en évidence les événements les plus significatifs, en distinguant les **pics** et les **nuisances durables**.\n\n### Volume maximum enregistré\n\nLa jauge indique le **niveau sonore le plus élevé** observé sur la période affichée. Elle sert à repérer un choc acoustique potentiel, sans tenir compte de sa durée.\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Indique l'intensité maximale (crête) enregistrée sur la période sélectionnée. Les codes couleurs (Vert à Rouge foncé) signalent immédiatement les niveaux critiques (>60dB, >75dB) nécessitant une attention particulière.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "displayName": "Sound Pressure Level (${__field.labels.frequency_weighting})",
          "fieldMinMax": false,
          "mappings": [],
          "max": 100,
          "min": 30,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "dark-green",
                "value": 30
              },
              {
                "color": "dark-yellow",
                "value": 45
              },
              {
                "color": "red",
                "value": 60
              },
              {
                "color": "dark-red",
                "value": 75
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 10,
        "w": 24,
        "x": 0,
        "y": 114
      },
      "id": 2,
      "options": {
        "minVizHeight": 75,
        "minVizWidth": 75,
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": true,
        "showThresholdMarkers": true,
        "sizing": "auto"
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\")\n  |> filter(fn: (r) => r[\"_field\"] == \"spl\")\n  |> keep(columns: [\"_time\", \"_value\", \"_field\", \"frequency_weighting\"])\n  |> max()",
          "refId": "A"
        }
      ],
      "title": "Volume Maximum Enregistré",
      "type": "gauge"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 124
      },
      "id": 20,
      "panels": [],
      "title": "Indicateurs Experts et Contexte",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 9,
        "w": 24,
        "x": 0,
        "y": 125
      },
      "id": 21,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Cette section applique des indicateurs courants de mesure acoustique pour caractériser l’ambiance sonore au-delà d’une moyenne simple.\n\n### Indicateurs L10 / L50 / L90 (sur 60 minutes)\n\nSur chaque fenêtre d’une heure, trois indicateurs sont calculés :\n- **L10** : Le niveau sonore dépassé pendant 10 % du temps. Il représente les événements sonores les plus forts (passages de voitures, cris, travaux).\n- **L50** : Le niveau dépassé pendant 50 % du temps. C'est l'indicateur de la \"tendance\" sonore globale.\n- **L90** : Le niveau dépassé pendant 90 % du temps. Il représente le niveau sonore calme, quand il n'y a pas d'événement particulier. C'est le \"bruit résiduel\" de la ville.\n\nCette lecture permet de séparer objectivement un bruit ambiant stable de pics plus rares mais plus forts.\n\n### Localisation du Capteur\n\nLa carte situe le capteur dans l’environnement. Ce repère est utile pour interpréter les variations (distance aux sources, obstacles, réflexions sur les façades).\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Répartition statistique du bruit sur l'ensemble de la période. Trois indicateurs basés sur la distribution des niveaux sonores: \n\n- L10 (Niveau de Pointe) : Niveau dépassé 10% du temps. Représente les événements bruyants (trafic, aboiements, travaux).\n- L50 (Niveau Médian): Le niveau sonore moyen ressenti la majorité du temps.\n- L90 (Bruit de Fond): Niveau dépassé 90% du temps. Représente le calme résiduel de l'environnement (ce qu'il reste quand tout s'arrête).\n\nCes valeurs permettent de distinguer les pics du niveau ambiant résiduel.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "dark-red",
            "mode": "fixed"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byRegexp",
              "options": "/.*L10.*/"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L10 (Pics)"
              }
            ]
          },
          {
            "matcher": {
              "id": "byRegexp",
              "options": "/.*L50.*/"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L50 (Médiane)"
              }
            ]
          },
          {
            "matcher": {
              "id": "byRegexp",
              "options": "/.*L90.*/"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L90 (Bruit de fond)"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 11,
        "w": 24,
        "x": 0,
        "y": 134
      },
      "id": 10,
      "options": {
        "displayMode": "lcd",
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": false
        },
        "maxVizHeight": 300,
        "minVizHeight": 16,
        "minVizWidth": 8,
        "namePlacement": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [],
          "fields": "",
          "values": false
        },
        "showUnfilled": true,
        "sizing": "auto",
        "valueMode": "color"
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"math\"\nimport \"timezone\"\noption location = timezone.location(name: \"Europe/Brussels\")\n\ndata = from(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\")\n  |> filter(fn: (r) => r[\"_field\"] == \"spl\")\n  |> group() \n\nl10 = data\n  |> quantile(q: 0.90)\n  |> map(fn: (r) => ({ _field: \"L10 (Pics)\", _value: math.round(x: r._value) }))\n\nl50 = data\n  |> quantile(q: 0.50)\n  |> map(fn: (r) => ({ _field: \"L50 (Médiane)\", _value: math.round(x: r._value) }))\n\nl90 = data\n  |> quantile(q: 0.10)\n  |> map(fn: (r) => ({ _field: \"L90 (Bruit de fond)\", _value: math.round(x: r._value) }))\n\nunion(tables: [l10, l50, l90])\n  |> group(columns: [\"_field\"])\n  |> yield(name: \"acoustic_stats\")",
          "refId": "A"
        }
      ],
      "title": "Signature Acoustique Globale (L10 / L50 / L90)",
      "type": "bargauge"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Calcul de la dynamique du bruit: Différence entre le niveau de pointe (L10) et le niveau de fond (L90).\n\n- Valeur élevée (> 15 dB) : Bruit fluctuant, trafic, événements ponctuels.\n- Valeur faible (< 5 dB) : Bruit monotone et continu. C'est la signature typique d'une **Pompe à Chaleur** ou d'une VMC.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "text",
            "mode": "fixed",
            "seriesBy": "last"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "opacity",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": true,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "dashed+area"
            }
          },
          "displayName": "Indice de Monotonie",
          "fieldMinMax": false,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              },
              {
                "color": "dark-orange",
                "value": 5
              },
              {
                "color": "dark-red",
                "value": 15
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byFrameRefID",
              "options": "B"
            },
            "properties": [
              {
                "id": "mappings",
                "value": [
                  {
                    "options": {
                      "from": 0,
                      "result": {
                        "color": "dark-green",
                        "index": 0,
                        "text": "Stable"
                      },
                      "to": 5
                    },
                    "type": "range"
                  },
                  {
                    "options": {
                      "from": 5,
                      "result": {
                        "color": "dark-orange",
                        "index": 1,
                        "text": "Fluctuant"
                      },
                      "to": 15
                    },
                    "type": "range"
                  },
                  {
                    "options": {
                      "from": 15,
                      "result": {
                        "color": "dark-red",
                        "index": 2,
                        "text": "Hautement variable"
                      },
                      "to": 100
                    },
                    "type": "range"
                  }
                ]
              },
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": true,
                  "tooltip": false,
                  "viz": true
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 9,
        "w": 24,
        "x": 0,
        "y": 145
      },
      "id": 22,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\n// Configuration de la zone horaire\noption location = timezone.location(name: \"Europe/Brussels\")\n\n// 1. Récupération et nettoyage des données\ndata = from(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> filter(fn: (r) => exists r._value) // On ignore les points vides\n\n// 2. Calcul du L10 (Pics sonores)\nl10 = data \n  |> aggregateWindow(every: 30m, fn: (column, tables=<-) => tables |> quantile(q: 0.90), createEmpty: false)\n\n// 3. Calcul du L90 (Bruit de fond)\nl90 = data \n  |> aggregateWindow(every: 30m, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n\njoin(tables: {l10: l10, l90: l90}, on: [\"_time\"])\n  |> map(fn: (r) => {\n      // Calcul de la différence brute\n      raw_diff = r._value_l10 - r._value_l90\n      \n      // Correction : Si négatif (erreur de calcul), on ramène à 0\n      val = if raw_diff < 0.0 then 0.0 else raw_diff\n      \n      return {\n          _time: r._time,\n          _value: val,\n          _field: \"Climat Sonore (L10-L90)\"\n      }\n  })",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\n// Configuration de la zone horaire\noption location = timezone.location(name: \"Europe/Brussels\")\n\n// 1. Récupération et nettoyage des données\ndata = from(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  |> filter(fn: (r) => exists r._value) // On ignore les points vides\n\n// 2. Calcul du L10 (Pics sonores)\nl10 = data \n  |> aggregateWindow(every: 30m, fn: (column, tables=<-) => tables |> quantile(q: 0.90), createEmpty: false)\n\n// 3. Calcul du L90 (Bruit de fond)\nl90 = data \n  |> aggregateWindow(every: 30m, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n\njoin(tables: {l10: l10, l90: l90}, on: [\"_time\"])\n  |> map(fn: (r) => {\n      // Calcul de la différence brute\n      raw_diff = math.round(x: r._value_l10 - r._value_l90)\n      \n      // Correction : Si négatif (erreur de calcul), on ramène à 0\n      val = if raw_diff < 0.0 then 0.0 else raw_diff\n      \n      return {\n          _time: r._time,\n          _value: val,\n          _field: \"Variability\"\n      }\n  })",
          "refId": "B"
        }
      ],
      "title": "Signature du Bruit: Dynamique & Monotonie",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Affiche la position du capteur à partir de coordonnées définies dans le tableau de bord (point fixe). Sert à interpréter les mesures en fonction de l’environnement immédiat (obstacles, voisinage, géométrie des lieux).",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 11,
        "w": 24,
        "x": 0,
        "y": 154
      },
      "id": 5,
      "options": {
        "basemap": {
          "config": {},
          "name": "Layer 0",
          "noRepeat": false,
          "type": "default"
        },
        "controls": {
          "mouseWheelZoom": true,
          "showAttribution": true,
          "showDebug": false,
          "showMeasure": false,
          "showScale": false,
          "showZoom": true
        },
        "layers": [
          {
            "config": {
              "blur": 50,
              "radius": 50,
              "weight": {
                "fixed": 1,
                "max": 1,
                "min": 0
              }
            },
            "filterData": {
              "id": "byRefId",
              "options": "A"
            },
            "layer-tooltip": true,
            "location": {
              "mode": "auto"
            },
            "name": "Layer 1",
            "opacity": 0.5,
            "tooltip": true,
            "type": "heatmap"
          }
        ],
        "tooltip": {
          "mode": "details"
        },
        "view": {
          "allLayers": true,
          "id": "coords",
          "lat": 50.599922,
          "lon": 4.32828,
          "noRepeat": false,
          "zoom": 17.78
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"array\"\n\narray.from(rows: [{\n    lat: 50.599724, \n    lon: 4.328188, \n    location_name: \"Extérieur, Jardin\",\n    sensor_type: \"Trotec SL400\"\n}])",
          "refId": "A"
        }
      ],
      "title": "Localisation du Capteur",
      "type": "geomap"
    }
  ],
  "preload": false,
  "refresh": "auto",
  "schemaVersion": 42,
  "tags": [],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-3h",
    "to": "now"
  },
  "timepicker": {
    "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "4h", "1d", "2d", "7d"]
  },
  "timezone": "browser",
  "title": "Noise Station",
  "uid": "adx4w44",
  "version": 1,
  "weekStart": "monday"
}
