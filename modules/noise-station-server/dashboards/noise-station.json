{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": 36,
  "links": [],
  "liveNow": true,
  "panels": [
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 11,
      "panels": [],
      "title": "A propos de Noise Station et réglementation en Région wallonne",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 29,
        "w": 12,
        "x": 0,
        "y": 1
      },
      "id": 6,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "# Noise Station\n\n### Un système de monitoring acoustique intelligent\n\nLa **Noise Station** est une solution de surveillance environnementale de haute précision conçue pour capturer, analyser et visualiser les niveaux sonores d'un espace en temps réel. Elle transforme des données acoustiques brutes en indicateurs visuels pour suivre l'évolution du bruit, détecter les pics et comprendre le profil sonore d'un lieu sur 24 heures.\n\n# Comment ça fonctionne ?\n\n### 1. La Capture (Le Matériel)\n\nLe système s'appuie sur un microphone professionnel de type **Trotec SL400** (équivalent du **CEM DT-8852**). Ce sonomètre de Classe 2 offre des fonctionnalités indispensables :\n-   **Double Pondération:** Supporte les courbes **dB(A)** (perception humaine) et **dB(C)** (basses fréquences).\n-   **Plage Dynamique:** Mesure précise de 30 à 130 dB (précision : 1,4 dB, résolution : 0,1 dB)\n-   **Modes Temporels:** Analyse en mode \"Fast\" (réactivité immédiate) ou \"Slow\" (stabilité).\n-   **Signaux numériques:** Uniquement les données numériques (et pas analogique) sont transmises. \n-   **Certification:** Livré avec certificat de calibration, conforme à IEC61672-1 Class 2\n\n### 2. Le Cœur du Système (L'Intelligence)\n\nLes données sont traitées par une unité de calcul (**Raspberry Pi**) et stockées dans une base de données temporelle (**InfluxDB**):\n*   **Nettoyage :** Filtrage des métadonnées pour une lecture fluide.\n*   **Agrégation :** Calcul de moyennes glissantes et détection de crêtes en temps réel.\n\n### 3. La Visualisation (Le Dashboard)\n\nLe dashboard est structuré en quatre axes complémentaires pour une lecture immédiate :\n\n*   **Vue Temps Réel (Live View) :** Un graphique temporel combinant les mesures brutes et une courbe lissée (**moyenne mobile 1 min**). Cela permet de distinguer les bruits de fond des pics soudains.\n*   **Pic de Volume (Volume Maximum Enregistré) :** Une jauge dynamique qui surveille le volume maximal atteint durant les **5 dernières minutes**. Elle utilise des seuils colorés (du vert au rouge foncé dès 80 dB) pour alerter sur les événements sonores récents.\n*   **Profil Statistique (Fréquence Sonore) :** Un histogramme qui regroupe les mesures des dernières 24 heures par paliers de décibels (arrondis à l'unité). Il permet de voir en un coup d'œil quel niveau de bruit est le plus fréquent dans l'environnement.\n*   **Distribution Horaire :** Un graphique en barres affichant la **moyenne sonore pour chaque heure** de la journée. Idéal pour identifier les cycles de pollution sonore (journée de travail vs nuit).\n*   **Géolocalisation :** Une carte intégrée affichant l'emplacement précis du capteur.\n\n# Pourquoi utiliser Noise Station ?\n\nPasser du ressenti subjectif (\"c'est bruyant\") à une mesure objective (\"la moyenne est de 65 dB avec des pics à 85 dB\"). Que ce soit pour le confort au travail, la surveillance de voisinage ou l'analyse environnementale, la **Noise Station** fournit une preuve scientifique et visuelle de la réalité acoustique de votre environnement.",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 29,
        "w": 12,
        "x": 12,
        "y": 1
      },
      "id": 7,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "# Réglementation en Région wallonne\n\nEn Région wallonne (https://www.ejustice.just.fgov.be/eli/arrete/2002/07/04/2002027815/justel), le cadre légal est clair et rigoureux. Depuis l’arrêté du Gouvernement wallon du 4 juillet 2022, des limites de bruit spécifiques s’appliquent aux PAC selon les différentes périodes de la journée :\n\n- En journée (7h-19h): le bruit ne doit pas dépasser 50 dB.\n- En transition (6h-7h, 19h-22h): la limite est réduite à 45 dB.\n- La nuit (22h-6h): le niveau sonore doit impérativement rester sous 40 dB.\n\nLe bruit se propage en cercle autour d'une unité extérieure (PAC). \nIl est donc crucial de faire attention aux surfaces environnantes, comme des murs ou d’autres bâtiments, qui peuvent réfléchir le son et provoquer un effet d’écho. Pour limiter cette résonance, maintenez au moins un mètre d’espace autour de la pompe, en particulier par rapport aux fenêtres, aux portes et aux chemins. Si l’unité est placée contre un mur, veillez à respecter une distance minimale de 30 centimètres — l’idéal étant de 50 centimètres — pour garantir une circulation sonore optimale. Il est également important de prendre en compte la distance entre la face avant de la pompe à chaleur et les trottoirs, qui doit être d’au moins 3 mètres et d’au moins 6 mètres pour les plantes.\n\nSource: https://www.bobex.be/fr-be/pompe-a-chaleur/installation/distance-voisin/\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 30
      },
      "id": 16,
      "panels": [],
      "title": "Surveillance en Temps Réel et Conformité",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 13,
        "w": 24,
        "x": 0,
        "y": 31
      },
      "id": 17,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Cette section met en regard le **niveau sonore en temps réel** et les **seuils réglementaires applicables en Région wallonne**.\n\n### Vue en Temps Réel\n\nLe panneau *Vue en Temps Réel* part des mesures **SPL** (dB) issues de la série `dt8852/spl`, puis applique le traitement suivant :\n\n1. **Conversion dB → énergie** : chaque valeur est convertie en échelle linéaire, afin de travailler sur une grandeur énergétique.\n2. **Fenêtrage 30 secondes** : les valeurs (en énergie) sont agrégées sur des fenêtres de **30 s**, ce qui produit un indicateur stable et robuste aux micro-pics.\n3. **Retour énergie → dB** : la valeur agrégée est reconvertie en décibels pour un affichage cohérent en dB.\n\n### Historique des Infractions\n\nUne seconde série calcule une **limite horaire** en fonction de l’heure locale (Europe/Brussels) :\n- **50 dB** entre 07h–19h  \n- **45 dB** entre 06h–07h et 19h–22h  \n- **40 dB** entre 22h–06h  \n\nCette limite est affichée en **ligne blanche pointillée** afin de visualiser immédiatement la marge de conformité.\n\nLes seuils de couleur sur la courbe (vert/jaune/orange/rouge) permettent d’identifier d’un coup d’œil si le niveau se situe sous 40/45/50 dB, ou s’il s’en approche / les dépasse.\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Affiche le SPL reconstruit sur des fenêtres de 30s à partir des mesures: conversion dB→énergie, agrégation en énergie, puis reconversion en dB. La courbe est comparée à une limite réglementaire dynamique (40/45/50 dB) calculée à partir de l’heure locale.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "green",
            "mode": "thresholds",
            "seriesBy": "last"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 25,
            "gradientMode": "scheme",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineStyle": {
              "fill": "solid"
            },
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": true,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "fieldMinMax": true,
          "mappings": [],
          "noValue": "0",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "dark-green",
                "value": 0
              },
              {
                "color": "dark-yellow",
                "value": 40
              },
              {
                "color": "dark-orange",
                "value": 45
              },
              {
                "color": "dark-red",
                "value": 50
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "_limit"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Limite en Région Wallonne"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "#ffffff",
                  "mode": "fixed"
                }
              },
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [10, 10],
                  "fill": "dash"
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 15,
        "w": 24,
        "x": 0,
        "y": 44
      },
      "id": 1,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\")\n  |> filter(fn: (r) => r[\"_field\"] == \"spl\")\n  // On garde la colonne frequency_weighting\n  |> keep(columns: [\"_time\", \"_value\", \"_field\", \"frequency_weighting\"])\n  \n  // Passage en échelle linéaire (énergie)\n  |> map(fn: (r) => ({\n      r with \n      _value: math.pow(x: 10.0, y: r._value / 10.0)\n  }))\n\n  // Calcul de la MOYENNE énergétique (Leq) par minute\n  // Note: mean est indispensable ici pour le calcul logarithmique\n  |> aggregateWindow(every: 30s, fn: mean, createEmpty: false)\n\n  // Retour en décibels ET renommage du flux\n  |> map(fn: (r) => ({\n      r with \n      _value: 10.0 * math.log10(x: r._value),\n      _field: \"Niveau de Pression Sonore\"\n  }))\n\n  |> yield(name: \"spl_result\")",
          "refId": "Live"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "ff9xpmhbcsb9ce"
          },
          "hide": false,
          "query": "import \"date\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"dt8852\" and r._field == \"spl\")\n  |> aggregateWindow(every: v.windowPeriod, fn: first)\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      return {\n          _time: r._time,\n          _limit: if h >= 7 and h < 19 then 50.0 \n                  else if h == 6 or (h >= 19 and h < 22) then 45.0 \n                  else 40.0\n      }\n  })",
          "refId": "A"
        }
      ],
      "title": "Vue en Temps Réel",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Encode la conformité minute par minute. Les données SPL sont agrégées par minute, puis comparées à la limite horaire (40/45/50 dB) calculée sur la même horodatation. Le résultat est un statut binaire: conforme ou infraction\n",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "axisPlacement": "auto",
            "fillOpacity": 70,
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineWidth": 0,
            "spanNulls": false
          },
          "mappings": [
            {
              "options": {
                "0": {
                  "color": "dark-red",
                  "index": 0,
                  "text": "Infraction"
                },
                "1": {
                  "color": "dark-green",
                  "index": 1,
                  "text": "Conforme"
                }
              },
              "type": "value"
            }
          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 5,
        "w": 24,
        "x": 0,
        "y": 59
      },
      "id": 8,
      "options": {
        "alignValue": "left",
        "legend": {
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "mergeValues": true,
        "rowHeight": 0.9,
        "showValue": "auto",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  // Fenêtrage pour alléger le rendu (ex: toutes les 1m)\n  |> aggregateWindow(every: 1m, fn: max, createEmpty: false)\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      limit = if h >= 7 and h < 19 then 50.0 \n              else if h == 6 or (h >= 19 and h < 22) then 45.0 \n              else 40.0\n      \n      return { _time: r._time, _field: \"Statut\", _value: if r._value > limit then \"0\" else \"1\" }\n  })",
          "refId": "A"
        }
      ],
      "title": "Historique des Infractions",
      "type": "state-timeline"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 64
      },
      "id": 14,
      "panels": [],
      "title": "Profil Sonore et Rythmes Horaires",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 6,
        "w": 24,
        "x": 0,
        "y": 65
      },
      "id": 15,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Cette section décrit la **signature acoustique** du lieu sur la durée, en distinguant le **bruit de fond** des épisodes plus marqués.\n\n### Fréquence sonore\n\nLes mesures sont d’abord regroupées pour réduire le volume de données, puis classées par **paliers de 3 dB**. Ce choix facilite l’interprétation, car un pas de 3 dB correspond à une variation énergétique significative.  \nLes séries sont ensuite séparées par périodes (jour, soirée, aube, nuit) afin de comparer les distributions selon l’heure.\n\n### Histogramme de Pression Sonore\n\nLe second graphique calcule la **médiane** du niveau sonore sur des fenêtres de **15 minutes**. La médiane réduit l’influence des bruits brefs et met en évidence l’ambiance sonore typique et les rythmes réguliers (jour/nuit, pics d’activité).\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Histogramme des niveaux sonores classés par paliers de 3 dB et séparés par périodes horaires (jour / aube / soirée / nuit). Les données sont préalablement regroupées pour limiter le volume affiché. Utile pour identifier le niveau dominant (bruit de fond) et la dispersion des niveaux.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "fillOpacity": 80,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "stacking": {
              "group": "A",
              "mode": "none"
            }
          },
          "mappings": [],
          "max": 120,
          "min": 30,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Jour (Limite 50dB)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-blue",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Soirée (Limite 45dB)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Aube / Matinée (Limite 45dB)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Nuit (Limite 40dB)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#000064",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 15,
        "w": 24,
        "x": 0,
        "y": 71
      },
      "id": 3,
      "options": {
        "combine": false,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\nimport \"date\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  // 1. Keep data volume safe (10s resolution)\n  |> aggregateWindow(every: 10s, fn: last, createEmpty: false)\n  |> map(fn: (r) => {\n      h = date.hour(t: r._time)\n      \n      // 2. Define the four distinct periods\n      period = if h >= 7 and h < 19 then \"Jour (Limite 50dB)\"\n               else if h >= 19 and h < 22 then \"Soirée (Limite 45dB)\"\n               else if h >= 6 and h < 7 then \"Aube / Matinée (Limite 45dB)\"\n               else \"Nuit (Limite 40dB)\"\n      \n      return { r with \n          // 3. Bucket by 3dB for acoustic significance\n          _value: math.floor(x: r._value / 3.0) * 3.0,\n          // 4. Use the period name as the field for the histogram series\n          _field: period\n      }\n  })\n  |> keep(columns: [\"_time\", \"_value\", \"_field\"])",
          "refId": "A"
        }
      ],
      "title": "Fréquence Sonore",
      "type": "histogram"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Affiche la médiane du niveau sonore par fenêtres de 15 minutes. Ce choix met en avant le niveau typique en limitant l’impact des événements brefs. Idéal pour visualiser les cycles d’activité et les périodes de calme relatif.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "fillOpacity": 80,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 2,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "fieldMinMax": true,
          "mappings": [],
          "max": 80,
          "min": 40,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 14,
        "w": 24,
        "x": 0,
        "y": 86
      },
      "id": 4,
      "options": {
        "barRadius": 0,
        "barWidth": 0.6,
        "colorByField": "Time",
        "fullHighlight": false,
        "groupWidth": 1,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": false
        },
        "orientation": "auto",
        "showValue": "auto",
        "stacking": "none",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        },
        "xField": "Time",
        "xTickLabelRotation": 0,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\")\n  |> filter(fn: (r) => r[\"_field\"] == \"spl\")\n  |> keep(columns: [\"_time\", \"_value\", \"_field\", \"frequency_weighting\"])\n  |> aggregateWindow(every: 15m, fn: mean, createEmpty: false)\n  |> map(fn: (r) => ({ \n      r with \n      _value: math.round(x: r._value),\n      _field: \"Niveau de Pression Sonore\" \n  }))  \n  |> yield(name: \"hourly_peaks\")",
          "refId": "A"
        }
      ],
      "title": "Histogramme de Pression Sonore",
      "type": "barchart"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 100
      },
      "id": 12,
      "panels": [],
      "title": "Analyse des Événements et Nuisances",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 10,
        "w": 24,
        "x": 0,
        "y": 101
      },
      "id": 13,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Ce module met en évidence les événements les plus significatifs, en distinguant les **pics** et les **nuisances durables**.\n\n### Volume maximum enregistré\n\nLa jauge indique le **niveau sonore le plus élevé** observé sur la période affichée. Elle sert à repérer un choc acoustique potentiel, sans tenir compte de sa durée.\n\n### Nuisances persistantes (> 60 dB)\n\nCe panneau recherche des séquences où le niveau reste **au-dessus de 60 dB** de manière continue pendant suffisamment longtemps pour être qualifié de nuisance.\n\nTraitement appliqué :\n1. Regroupement des mesures sur des tranches courtes pour stabiliser l’analyse.\n2. Lissage réalisé sur une grandeur énergétique (et non directement en dB) afin d’éviter que de petites oscillations autour du seuil ne fragmentent artificiellement une séquence.\n3. Calcul de la durée pendant laquelle le niveau reste au-dessus du seuil, puis filtrage pour ne conserver que les épisodes d’au moins **2 minutes**.\n\nLe graphique affiche simultanément l’intensité (en dB) et la durée de l’épisode (en secondes), afin de relier niveau et persistance.\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Analyse approfondie des événements sonores significatifs. Ce panneau isole et visualise les périodes où le niveau sonore a dépassé 60 dB de manière continue pendant plus de 2 minutes (120s), permettant d'identifier les nuisances longues et persistantes par rapport aux bruits transitoires.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 6,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": true,
            "spanNulls": true,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "dtdurations"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Durée de la nuisance (> 60dB)"
            },
            "properties": [
              {
                "id": "custom.axisPlacement",
                "value": "right"
              },
              {
                "id": "unit",
                "value": "dtdurations"
              },
              {
                "id": "custom.lineInterpolation",
                "value": "stepBefore"
              },
              {
                "id": "custom.fillOpacity",
                "value": 50
              },
              {
                "id": "custom.scaleDistribution",
                "value": {
                  "log": 2,
                  "type": "log"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Intensité"
            },
            "properties": [
              {
                "id": "unit",
                "value": "dB"
              },
              {
                "id": "custom.lineInterpolation",
                "value": "smooth"
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "#fffd0038",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 11,
        "w": 24,
        "x": 0,
        "y": 111
      },
      "id": 9,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"math\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n  \n  // 1. Fenêtrage de base\n  |> aggregateWindow(every: 10s, fn: max, createEmpty: false)\n\n  // --- DÉBUT DU LISSAGE ÉNERGÉTIQUE ---\n  // 2. Conversion des dB en échelle linéaire (énergie)\n  |> map(fn: (r) => ({ r with _value: math.pow(x: 10.0, y: r._value / 10.0) }))\n  \n  // 3. Moyenne glissante sur 30 secondes (6 points de 5s)\n  |> exponentialMovingAverage(n: 12)\n  \n  // 4. Retour en décibels (échelle logarithmique)\n  |> map(fn: (r) => ({ r with _value: 10.0 * math.log10(x: r._value) }))\n  // --- FIN DU LISSAGE ÉNERGÉTIQUE ---\n\n  // 5. Calcul de la durée consécutive au dessus de 55.0 dB\n  // On le fait sur la valeur lissée pour éviter les micro-coupures du compteur\n  |> stateDuration(fn: (r) => r._value > 60.0, column: \"noisy_seconds\", unit: 1s)\n\n  // 6. Nettoyage : transformer les -1 (sous le seuil) en 0\n  |> map(fn: (r) => ({\n      r with \n      noisy_seconds: if r.noisy_seconds == -1 then 0 else r.noisy_seconds\n  }))\n\n  // 7. FILTRE : On ne garde que les séquences qui durent plus de 120s (2 minutes)\n  |> filter(fn: (r) => r.noisy_seconds >= 120)\n\n  // 8. Formatage final pour un affichage propre dans Grafana\n  |> map(fn: (r) => ({\n      _time: r._time,\n      \"Intensité\": math.round(x: r._value * 10.0) / 10.0, // Arrondi 1 décimale\n      \"Durée de la nuisance (> 60dB)\": float(v: r.noisy_seconds)\n  }))\n  |> yield(name: \"nuisances_analyse\")",
          "refId": "A"
        }
      ],
      "title": "Nuisances persistantes (> 60 dB)",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Indique l'intensité maximale (crête) enregistrée sur la période sélectionnée. Les codes couleurs (Vert à Rouge foncé) signalent immédiatement les niveaux critiques (>60dB, >75dB) nécessitant une attention particulière.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "fieldMinMax": false,
          "mappings": [],
          "max": 100,
          "min": 30,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "dark-green",
                "value": 30
              },
              {
                "color": "dark-yellow",
                "value": 45
              },
              {
                "color": "red",
                "value": 60
              },
              {
                "color": "dark-red",
                "value": 75
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 10,
        "w": 24,
        "x": 0,
        "y": 122
      },
      "id": 2,
      "options": {
        "minVizHeight": 75,
        "minVizWidth": 75,
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": true,
        "showThresholdMarkers": true,
        "sizing": "auto"
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"math\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Brussels\")\n\nfrom(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\")\n  |> filter(fn: (r) => r[\"_field\"] == \"spl\")\n  |> keep(columns: [\"_time\", \"_value\", \"_field\", \"frequency_weighting\"])\n  |> max()",
          "refId": "A"
        }
      ],
      "title": "Volume Maximum Enregistré",
      "type": "gauge"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 132
      },
      "id": 20,
      "panels": [],
      "title": "Indicateurs Experts et Contexte",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 9,
        "w": 24,
        "x": 0,
        "y": 133
      },
      "id": 21,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "Cette section applique des indicateurs courants de mesure acoustique pour caractériser l’ambiance sonore au-delà d’une moyenne simple.\n\n### Indicateurs L10 / L50 / L90 (sur 60 minutes)\n\nSur chaque fenêtre d’une heure, trois indicateurs sont calculés :\n- **L10** : Le niveau sonore dépassé pendant 10 % du temps. Il représente les événements sonores les plus forts (passages de voitures, cris, travaux).\n- **L50** : Le niveau dépassé pendant 50 % du temps. C'est l'indicateur de la \"tendance\" sonore globale.\n- **L90** : Le niveau dépassé pendant 90 % du temps. Il représente le niveau sonore calme, quand il n'y a pas d'événement particulier. C'est le \"bruit résiduel\" de la ville.\n\nCette lecture permet de séparer objectivement un bruit ambiant stable de pics plus rares mais plus forts.\n\n### Localisation du Capteur\n\nLa carte situe le capteur dans l’environnement. Ce repère est utile pour interpréter les variations (distance aux sources, obstacles, réflexions sur les façades).\n",
        "mode": "markdown"
      },
      "pluginVersion": "12.3.1",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Répartition statistique du bruit sur l'ensemble de la période. Trois indicateurs basés sur la distribution des niveaux sonores: \n\n- L10 (Niveau de Pointe) : Niveau dépassé 10% du temps. Représente les événements bruyants (trafic, aboiements, travaux).\n- L50 (Niveau Médian): Le niveau sonore moyen ressenti la majorité du temps.\n- L90 (Bruit de Fond): Niveau dépassé 90% du temps. Représente le calme résiduel de l'environnement (ce qu'il reste quand tout s'arrête).\n\nCes valeurs permettent de distinguer les pics du niveau ambiant résiduel.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "dark-red",
            "mode": "fixed"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byRegexp",
              "options": "/.*L10.*/"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L10 (Pics)"
              }
            ]
          },
          {
            "matcher": {
              "id": "byRegexp",
              "options": "/.*L50.*/"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L50 (Médiane)"
              }
            ]
          },
          {
            "matcher": {
              "id": "byRegexp",
              "options": "/.*L90.*/"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "L90 (Bruit de fond)"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 11,
        "w": 24,
        "x": 0,
        "y": 142
      },
      "id": 10,
      "options": {
        "displayMode": "lcd",
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": false
        },
        "maxVizHeight": 300,
        "minVizHeight": 16,
        "minVizWidth": 8,
        "namePlacement": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [],
          "fields": "",
          "values": false
        },
        "showUnfilled": true,
        "sizing": "auto",
        "valueMode": "color"
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"math\"\nimport \"timezone\"\noption location = timezone.location(name: \"Europe/Brussels\")\n\ndata = from(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\")\n  |> filter(fn: (r) => r[\"_field\"] == \"spl\")\n  |> group() \n\nl10 = data\n  |> quantile(q: 0.90)\n  |> map(fn: (r) => ({ _field: \"L10 (Pics)\", _value: math.round(x: r._value) }))\n\nl50 = data\n  |> quantile(q: 0.50)\n  |> map(fn: (r) => ({ _field: \"L50 (Médiane)\", _value: math.round(x: r._value) }))\n\nl90 = data\n  |> quantile(q: 0.10)\n  |> map(fn: (r) => ({ _field: \"L90 (Bruit de fond)\", _value: math.round(x: r._value) }))\n\nunion(tables: [l10, l50, l90])\n  |> group(columns: [\"_field\"])\n  |> yield(name: \"acoustic_stats\")",
          "refId": "A"
        }
      ],
      "title": "Signature Acoustique Globale (L10 / L50 / L90)",
      "type": "bargauge"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Calcul de la dynamique du bruit: Différence entre le niveau de pointe (L10) et le niveau de fond (L90).\n\n- Valeur élevée (> 15 dB) : Bruit fluctuant, trafic, événements ponctuels.\n- Valeur faible (< 5 dB) : Bruit monotone et continu. C'est la signature typique d'une **Pompe à Chaleur** ou d'une VMC.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "opacity",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineWidth": 2,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "area",
              "palette": "classic"
            }
          },
          "displayName": "Indice de Monotonie (L10 - L90)",
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "red",
                "value": 0
              },
              {
                "color": "#EAB839",
                "value": 5
              },
              {
                "color": "green",
                "value": 15
              }
            ]
          },
          "unit": "dB"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Indice de Monotonie (L10 - L90)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "purple",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 9,
        "w": 24,
        "x": 0,
        "y": 153
      },
      "id": 22,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "query": "import \"math\"\nimport \"timezone\"\noption location = timezone.location(name: \"Europe/Brussels\")\n\ndata = from(bucket: \"default\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"dt8852\" and r[\"_field\"] == \"spl\")\n\nl10 = data |> aggregateWindow(every: 60m, fn: (column, tables=<-) => tables |> quantile(q: 0.90), createEmpty: false)\nl90 = data |> aggregateWindow(every: 60m, fn: (column, tables=<-) => tables |> quantile(q: 0.10), createEmpty: false)\n\njoin(tables: {l10: l10, l90: l90}, on: [\"_time\"])\n  |> map(fn: (r) => ({\n      _time: r._time,\n      _value: r._value_l10 - r._value_l90,\n      _field: \"Indice de Monotonie (L10 - L90)\"\n  }))",
          "refId": "A"
        }
      ],
      "title": "Signature du Bruit: Dynamique & Monotonie",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "ff9xpmhbcsb9ce"
      },
      "description": "Affiche la position du capteur à partir de coordonnées définies dans le tableau de bord (point fixe). Sert à interpréter les mesures en fonction de l’environnement immédiat (obstacles, voisinage, géométrie des lieux).",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 11,
        "w": 24,
        "x": 0,
        "y": 162
      },
      "id": 5,
      "options": {
        "basemap": {
          "config": {},
          "name": "Layer 0",
          "noRepeat": false,
          "type": "default"
        },
        "controls": {
          "mouseWheelZoom": true,
          "showAttribution": true,
          "showDebug": false,
          "showMeasure": false,
          "showScale": false,
          "showZoom": true
        },
        "layers": [
          {
            "config": {
              "blur": 50,
              "radius": 50,
              "weight": {
                "fixed": 1,
                "max": 1,
                "min": 0
              }
            },
            "filterData": {
              "id": "byRefId",
              "options": "A"
            },
            "layer-tooltip": true,
            "location": {
              "mode": "auto"
            },
            "name": "Layer 1",
            "opacity": 0.5,
            "tooltip": true,
            "type": "heatmap"
          }
        ],
        "tooltip": {
          "mode": "details"
        },
        "view": {
          "allLayers": true,
          "id": "coords",
          "lat": 50.599922,
          "lon": 4.32828,
          "noRepeat": false,
          "zoom": 17.78
        }
      },
      "pluginVersion": "12.3.1",
      "targets": [
        {
          "hide": false,
          "query": "import \"array\"\n\narray.from(rows: [{\n    lat: 50.599724, \n    lon: 4.328188, \n    location_name: \"Extérieur, Jardin\",\n    sensor_type: \"Trotec SL400\"\n}])",
          "refId": "A"
        }
      ],
      "title": "Localisation du Capteur",
      "type": "geomap"
    }
  ],
  "preload": false,
  "refresh": "auto",
  "schemaVersion": 42,
  "tags": [],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-3h",
    "to": "now"
  },
  "timepicker": {
    "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "4h", "1d", "2d", "7d"]
  },
  "timezone": "browser",
  "title": "Noise Station",
  "uid": "adx4w44",
  "version": 1,
  "weekStart": "monday"
}
